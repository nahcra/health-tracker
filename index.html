78% of storage used … If you run out, you can't create, edit, and upload files.
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workout & Food Tracker</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-analytics-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script> <style>
        /* CSS Variables */
        :root {
            --bg-dark: #1a1a2e;
            --primary-dark: #1f1f38;
            --text-light: #e0e0e0;
            --text-muted: #8c8c9a;
            --accent-primary: #00a8ff;
            --accent-secondary: #2ecc71;
            --accent-tertiary: #9b59b6; /* For Recovery */
            --accent-danger: #e74c3c;
            --border-color: #313154;
        }

        /* Universal Box-sizing */
        * { box-sizing: border-box; margin: 0; padding: 0; }

        /* Body Styles */
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-light);
            line-height: 1.6;
        }

        /* --- Welcome Screen --- */
        .welcome-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--bg-dark);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 1000;
            transition: opacity 1s ease-out 2.5s, visibility 1s ease-out 2.5s;
            opacity: 1; visibility: visible;
        }
        .welcome-screen.hidden { opacity: 0; visibility: hidden; }
        .logo-container { opacity: 0; transform: scale(0.5); animation: logo-fade-in 1.5s forwards; }
        .welcome-logo { width: 120px; height: 120px; margin-bottom: 20px; }
        .welcome-title { font-size: 3rem; color: #fff; text-shadow: 0 0 15px var(--accent-primary); opacity: 0; transform: translateY(20px); animation: title-fade-in 1.5s forwards 0.5s; }
        @keyframes logo-fade-in { to { opacity: 1; transform: scale(1); } }
        @keyframes title-fade-in { to { opacity: 1; transform: translateY(0); } }

        /* Container for main content */
        .container { max-width: 900px; margin: 20px auto; padding: 20px; }
        
        /* --- Profile & Headers --- */
        .profile-section { background-color: var(--primary-dark); padding: 20px; border-radius: 12px; margin-bottom: 40px; border: 1px solid var(--border-color); }
        .profile-section h2 { margin-top: 0; margin-bottom: 20px; text-align: center; }
        .profile-inputs { display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; align-items: center; }
        .profile-inputs input { background-color: var(--bg-dark); color: var(--text-light); border: 1px solid var(--border-color); border-radius: 8px; padding: 10px 15px; font-family: 'Poppins', sans-serif; font-size: 1rem; width: 200px; text-align: center; transition: border-color 0.3s; }
        .profile-inputs input:focus { outline: none; border-color: var(--accent-primary); }
        .grocery-link-btn {
            background-color: var(--accent-secondary);
            color: #fff;
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        .grocery-link-btn:hover { background-color: #27ae60; }

        h1 { text-align: center; font-size: 2.5rem; color: #fff; margin-bottom: 30px; text-shadow: 0 0 10px var(--accent-primary); }
        h2 { font-size: 2rem; color: var(--accent-primary); border-bottom: 2px solid var(--border-color); padding-bottom: 10px; margin: 50px 0 30px; }
        
        /* --- Day Card, Food Tracker, etc. Styles --- */
        .day-card { background-color: var(--primary-dark); border: 1px solid var(--border-color); border-radius: 12px; padding: 25px; margin-bottom: 25px; box-shadow: 0 8px 20px rgba(0,0,0,0.2); transition: transform 0.3s ease, box-shadow 0.3s ease; position: relative; border-left: 5px solid transparent; }
        .day-card.completed-day { border-left-color: var(--accent-secondary); opacity: 0.8; }
        .day-card.missed-day { border-left-color: var(--accent-danger); opacity: 0.7; }
        .day-card[data-type="recovery"] { border-left-color: var(--accent-tertiary); }
        .day-card:hover { transform: translateY(-5px); box-shadow: 0 12px 25px rgba(0,0,0,0.3); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .card-header h3 { font-size: 1.5rem; color: #fff; }
        .quote-of-the-day { font-style: italic; color: var(--text-muted); border-left: 3px solid var(--accent-primary); padding-left: 15px; margin: 20px 5px 25px 5px; font-size: 1rem; }
        .food-toggle { background-color: var(--bg-dark); border: 1px solid var(--border-color); color: var(--accent-secondary); padding: 10px 15px; border-radius: 8px; cursor: pointer; display: block; width: 100%; text-align: left; font-family: 'Poppins', sans-serif; font-size: 1.1rem; font-weight: 600; margin-bottom: 15px; transition: background-color 0.3s; }
        .food-toggle:hover { background-color: #2a2a4e; }
        .food-plan { display: none; padding: 15px; background-color: rgba(0,0,0,0.2); border-radius: 8px; }
        .meal-list { list-style: none; padding: 0; }
        .meal-item { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; flex-wrap: wrap; }
        .meal-item .meal-desc { flex-grow: 1; color: var(--text-light); }
        .meal-item strong { color: var(--accent-secondary); }
        .meal-item .meal-controls { display: flex; align-items: center; margin-left: 15px; }
        .meal-item input[type="time"] { background-color: var(--bg-dark); color: var(--text-light); border: 1px solid var(--border-color); border-radius: 5px; padding: 5px; }
        .exercise-list { list-style-type: none; margin-top: 20px; }
        .exercise-item { margin-bottom: 20px; padding: 15px; border-left: 4px solid var(--accent-primary); transition: all 0.3s ease; background-color: rgba(0,0,0,0.1); border-radius: 0 8px 8px 0; }
        .exercise-item.completed { border-left-color: var(--accent-secondary); opacity: 0.6; }
        .exercise-item.completed .exercise-name { text-decoration: line-through; }
        .exercise-name { font-weight: 600; font-size: 1.1rem; margin-bottom: 10px; display: block; }
        .custom-checkbox { display: inline-flex; align-items: center; cursor: pointer; margin: 0 10px; font-size: 0.95rem; }
        .custom-checkbox input { display: none; }
        .checkmark { width: 22px; height: 22px; background-color: rgba(0,0,0,0.2); border: 2px solid var(--border-color); border-radius: 5px; margin-right: 8px; position: relative; transition: all 0.2s ease; }
        .custom-checkbox:hover .checkmark { border-color: var(--accent-primary); }
        .custom-checkbox input:checked + .checkmark { background-color: var(--accent-primary); border-color: var(--accent-primary); }
        .day-card[data-type="recovery"] .custom-checkbox input:checked + .checkmark, .meal-item .custom-checkbox input:checked + .checkmark { background-color: var(--accent-secondary); border-color: var(--accent-secondary); }
        .checkmark::after { content: ''; position: absolute; display: none; left: 7px; top: 2px; width: 5px; height: 12px; border: solid white; border-width: 0 3px 3px 0; transform: rotate(45deg); }
        .custom-checkbox input:checked + .checkmark::after { display: block; }
        .progress-bar-container { width: 100%; background-color: var(--bg-dark); border-radius: 5px; margin-top: 20px; overflow: hidden; border: 1px solid var(--border-color); }
        .progress-bar { width: 0%; height: 12px; background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary)); border-radius: 5px; transition: width 0.5s ease-in-out; }
        p.card-text { font-size: 1.1rem; color: var(--text-muted); margin-bottom: 15px; }
        .timer { margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color); text-align: center; }
        .timer-display { font-size: 2.5rem; font-weight: 600; color: var(--text-light); margin-bottom: 15px; }
        .timer-controls button { background-color: var(--bg-dark); color: var(--accent-primary); border: 1px solid var(--accent-primary); padding: 8px 16px; border-radius: 5px; cursor: pointer; font-family: 'Poppins', sans-serif; margin: 0 5px; transition: background-color 0.3s, color 0.3s; }
        .timer-controls button:hover { background-color: var(--accent-primary); color: var(--bg-dark); }
        .day-card[data-type="recovery"] .timer-controls button { color: var(--accent-tertiary); border-color: var(--accent-tertiary); }
        .day-card[data-type="recovery"] .timer-controls button:hover { background-color: var(--accent-tertiary); color: var(--bg-dark); }
        .timer-controls button.pause-btn.running { background-color: var(--accent-danger); border-color: var(--accent-danger); color: var(--text-light); }
        .missed-workouts-section { background-color: var(--primary-dark); padding: 20px; border-radius: 12px; margin-top: 40px; border: 1px solid var(--accent-danger); }
        #missed-workouts-list { list-style-type: none; color: var(--text-muted); }
        #missed-workouts-list li { padding: 5px 0; border-bottom: 1px solid var(--border-color); }
        #missed-workouts-list li:last-child { border-bottom: none; }
    </style>
</head>
<body>

    <div class="welcome-screen">
        <div class="logo-container">
            <svg class="welcome-logo" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" clip-rule="evenodd" d="M100 25C141.421 25 175 58.5786 175 100C175 141.421 141.421 175 100 175C58.5786 175 25 141.421 25 100C25 58.5786 58.5786 25 100 25ZM100 0C44.7715 0 0 44.7715 0 100C0 155.228 44.7715 200 100 200C155.228 200 200 155.228 200 100C200 44.7715 155.228 0 100 0Z" fill="#313154"/>
                <path d="M60 100H80L90 120L110 80L120 100H140" stroke="#00a8ff" stroke-width="12" stroke-linecap="round" stroke-linejoin="round"/>
                <rect x="40" y="90" width="30" height="20" rx="5" fill="#00a8ff"/>
                <rect x="130" y="90" width="30" height="20" rx="5" fill="#00a8ff"/>
            </svg>
        </div>
        <h1 class="welcome-title">Workout Tracker</h1>
    </div>

    <div id="auth-container" class="container" style="display: none;">
        <h2>Login / Sign Up</h2>
        <div class="profile-inputs" style="flex-direction: column;">
            <input type="email" id="authEmail" placeholder="Email" required>
            <input type="password" id="authPassword" placeholder="Password" required>
            <button id="signInBtn" class="grocery-link-btn" style="background-color: var(--accent-primary);">Sign In</button>
            <button id="signUpBtn" class="grocery-link-btn" style="background-color: var(--accent-secondary);">Sign Up</button>
            <p id="authError" style="color: var(--accent-danger); margin-top: 10px;"></p>
        </div>
    </div>

    <div id="app-container" class="container" style="display: none;">
        <div class="profile-section">
            <h2>My Profile</h2>
            <div class="profile-inputs">
                <input type="text" id="userName" placeholder="Enter Your Name">
                <input type="text" id="userWeight" placeholder="Enter Current Weight">
                <a href="./grocery_list.html" class="grocery-link-btn">Go to Grocery List</a>
                <button id="signOutBtn" class="grocery-link-btn" style="background-color: var(--accent-danger);">Sign Out</button>
            </div>
        </div>

        <h1>My Health Plan</h1> 
        
        <div style="text-align: center; margin-bottom: 20px;">
            <label for="startDatePicker" style="font-size: 1.2rem; margin-right: 10px;">Plan Starts On:</label>
            <input type="date" id="startDatePicker" style="padding: 8px; border-radius: 5px; border: 1px solid var(--border-color); background-color: var(--primary-dark); color: var(--text-light);">
        </div>

        <section id="health-plan-container"></section> 
        
        <div class="missed-workouts-section">
            <h2>Missed Entries</h2>
            <ul id="missed-workouts-list"></ul>
        </div>
    </div>

    <script>
        // Your web app's Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyCXZgNctLWAu0haKvd90_hFAlo1WHM1n7Q",
          authDomain: "myhealthtrackerapp.firebaseapp.com",
          projectId: "myhealthtrackerapp",
          storageBucket: "myhealthtrackerapp.firebasestorage.app",
          messagingSenderId: "234509938064",
          appId: "1:234509938064:web:ab0c8e5af909b83ee99715",
          measurementId: "G-HZYD9L44TC"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const analytics = firebase.analytics();
        const db = firebase.firestore(); // Initialize Firestore
        const auth = firebase.auth(); // Initialize Auth

        // USER_ID will now be dynamic based on authenticated user
        let USER_ID = null; // Will be set by auth state listener
    </script>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- UI Element References ---
        const welcomeScreen = document.querySelector('.welcome-screen');
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');

        const authEmailInput = document.getElementById('authEmail');
        const authPasswordInput = document.getElementById('authPassword');
        const signInBtn = document.getElementById('signInBtn');
        const signUpBtn = document.getElementById('signUpBtn');
        const authErrorText = document.getElementById('authError');
        const signOutBtn = document.getElementById('signOutBtn');

        const userNameInput = document.getElementById('userName');
        const userWeightInput = document.getElementById('userWeight');
        const startDatePicker = document.getElementById('startDatePicker');
        const healthPlanContainer = document.getElementById('health-plan-container');
        const missedWorkoutsList = document.getElementById('missed-workouts-list');
        
        // --- WELCOME SCREEN LOGIC ---
        setTimeout(() => { welcomeScreen.classList.add('hidden'); }, 4000);

        // --- FIREBASE AUTHENTICATION FUNCTIONS ---
        async function handleSignUp() {
            try {
                const email = authEmailInput.value;
                const password = authPasswordInput.value;
                if (!email || !password) {
                    authErrorText.textContent = "Please enter email and password.";
                    return;
                }
                // Basic password validation
                if (password.length < 6) {
                    authErrorText.textContent = "Password should be at least 6 characters.";
                    return;
                }
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                console.log("Signed up:", userCredential.user.uid);
                authErrorText.textContent = ""; // Clear error
            } catch (error) {
                authErrorText.textContent = error.message;
                console.error("Sign up error:", error);
            }
        }

        async function handleSignIn() {
            try {
                const email = authEmailInput.value;
                const password = authPasswordInput.value;
                if (!email || !password) {
                    authErrorText.textContent = "Please enter email and password.";
                    return;
                }
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                console.log("Signed in:", userCredential.user.uid);
                authErrorText.textContent = ""; // Clear error
            } catch (error) {
                authErrorText.textContent = error.message;
                console.error("Sign in error:", error);
            }
        }

        async function handleSignOut() {
            try {
                await auth.signOut();
                console.log("Signed out.");
            } catch (error) {
                console.error("Sign out error:", error);
            }
        }

        // --- AUTH STATE CHANGE LISTENER ---
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                // User is signed in. Show app content.
                USER_ID = user.uid; // Set dynamic USER_ID
                authContainer.style.display = 'none';
                appContainer.style.display = 'block';
                console.log("User logged in:", USER_ID);

                // Load user-specific data
                await loadProfileData();
                await setAndLoadStartDate(); // This now relies on USER_ID for Firestore
            } else {
                // User is signed out. Show auth screen.
                USER_ID = null; // Clear USER_ID
                authContainer.style.display = 'block';
                appContainer.style.display = 'none';
                console.log("User logged out.");
                // Clear inputs/UI for next login or new user
                authEmailInput.value = '';
                authPasswordInput.value = '';
                userNameInput.value = '';
                userWeightInput.value = '';
                healthPlanContainer.innerHTML = ''; // Clear displayed plan
                missedWorkoutsList.innerHTML = '<li>Please log in to see your plan.</li>';
            }
        });

        // --- Add Event Listeners for Auth Buttons ---
        signInBtn.addEventListener('click', handleSignIn);
        signUpBtn.addEventListener('click', handleSignUp);
        signOutBtn.addEventListener('click', handleSignOut);


        // --- FIREBASE DATA FUNCTIONS (UPDATED TO USE DYNAMIC USER_ID) ---
        async function saveProfileData(name, weight) {
            if (!USER_ID) { console.warn("No user ID. Cannot save profile data."); return; }
            try {
                await db.collection('users').doc(USER_ID).set({
                    userName: name,
                    userWeight: weight,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                console.log("Profile data saved to Firebase for user:", USER_ID);
            } catch (e) {
                console.error("Error saving profile data: ", e);
            }
        }

        async function loadProfileData() {
            if (!USER_ID) { console.warn("No user ID. Cannot load profile data."); return; }
            try {
                const doc = await db.collection('users').doc(USER_ID).get();
                if (doc.exists) {
                    const data = doc.data();
                    userNameInput.value = data.userName || '';
                    userWeightInput.value = data.userWeight || '';
                    console.log("Profile data loaded for user:", USER_ID);
                } else {
                    console.log("No profile data found for user:", USER_ID);
                    userNameInput.value = '';
                    userWeightInput.value = '';
                }
            } catch (e) {
                console.error("Error loading profile data: ", e);
            }
        }

        async function saveCardStateToFirestore(cardId, data) {
            if (!USER_ID) { console.warn("No user ID. Cannot save card state."); return; }
            try {
                await db.collection('users').doc(USER_ID).collection('daily_entries').doc(cardId).set(data, { merge: true });
                // console.log(`Card state for ${cardId} saved.`); // Keep commented for less console spam
            } catch (e) {
                console.error(`Error saving card state for ${cardId}: `, e);
            }
        }

        async function loadCardStateFromFirestore(cardId) {
            if (!USER_ID) return null; // Cannot load if no user ID
            try {
                const doc = await db.collection('users').doc(USER_ID).collection('daily_entries').doc(cardId).get();
                if (doc.exists) {
                    return doc.data();
                }
            } catch (e) {
                console.error(`Error loading card state for ${cardId}: `, e);
            }
            return null;
        }

        // --- INITIAL LOAD & EVENT LISTENERS (Adjusted) ---
        // Profile inputs now save data to Firebase
        userNameInput.addEventListener('input', (e) => saveProfileData(e.target.value, userWeightInput.value));
        userWeightInput.addEventListener('input', (e) => saveProfileData(userNameInput.value, e.target.value));

        // Set and Load Start Date (now Firestore-first)
        async function setAndLoadStartDate() {
            if (!USER_ID) { // If no user, default to today for display, but won't save.
                const today = new Date();
                startDatePicker.value = today.toISOString().split('T')[0];
                renderHealthPlan();
                return;
            }

            let savedStartDate = null;
            try {
                const doc = await db.collection('users').doc(USER_ID).get();
                if (doc.exists && doc.data().planStartDate) {
                    savedStartDate = doc.data().planStartDate;
                }
            } catch (e) {
                console.error("Error loading start date from Firestore: ", e);
            }

            if (savedStartDate) {
                startDatePicker.value = savedStartDate;
            } else {
                const today = new Date();
                const todayISO = today.toISOString().split('T')[0];
                startDatePicker.value = todayISO;
                // Save initial start date to Firestore for new users
                await db.collection('users').doc(USER_ID).set({ planStartDate: todayISO }, { merge: true });
            }
            renderHealthPlan();
        }

        // startDatePicker now triggers re-render and Firestore save
        startDatePicker.addEventListener('change', async function() {
            if (!USER_ID) { console.warn("No user ID. Cannot save start date."); return; }
            await db.collection('users').doc(USER_ID).set({ planStartDate: this.value }, { merge: true });
            renderHealthPlan();
        });


        // --- WORKOUT & FOOD PLAN TEMPLATE DATA ---
        const healthPlanTemplate = [
            // Week 1 Patterns
            { title: 'Chest Day', type: 'strength', quote: "The only bad workout is the one that didn't happen.", exercises: [{ name: 'Bench Press', sets: 4, reps: 8 }, { name: 'Incline Dumbbell Press', sets: 3, reps: 10 }, { name: 'Dumbbell Flyes', sets: 3, reps: 12 }, { name: 'Push-ups', sets: 3, reps: 'To Failure' }], meals: { breakfast: 'Greek yogurt (1 cup) + 1/2 cup mixed berries + 1 tbsp chia seeds.', lunch: 'Large mixed green salad + 4-5 oz grilled chicken + vinaigrette.', dinner: 'Baked cod (5-6 oz) + 1 cup roasted asparagus + 1/2 cup quinoa.', snacks: 'N/A (Focus on water/herbal tea if hungry)' } },
            { title: 'Back Day', type: 'strength', quote: "Success isn't always about greatness. It's about consistency.", exercises: [{ name: 'Deadlifts', sets: 4, reps: 6 }, { name: 'Pull-ups / Lat Pulldowns', sets: 3, reps: 8 }, { name: 'Bent-Over Rows', sets: 3, reps: 10 }, { name: 'Face Pulls', sets: 3, reps: 15 }], meals: { breakfast: '2 scrambled eggs + 1 slice whole-grain toast + 1/4 avocado.', lunch: 'Leftover baked cod + asparagus + quinoa.', dinner: 'Turkey stir-fry (5 oz) + 2 cups veggies + 1/2 cup brown rice.', snacks: 'Optional: Small protein shake post-workout.' } },
            { title: 'Cardio & Stretching', type: 'cardio', quote: "Your body can stand almost anything. It’s your mind that you have to convince.", description: '30 minutes of moderate-intensity cardio, followed by 15 minutes of full-body stretching.', meals: { breakfast: 'Oatmeal (1/2 cup dry) + protein + banana + almond butter.', lunch: 'Salmon salad (4-5 oz) + spinach + cherry tomatoes.', dinner: 'Chicken breast (5 oz) + green beans + mashed sweet potato.', snacks: 'N/A (Focus on water/herbal tea if hungry)'' } },
            { title: 'Leg Day', type: 'strength', quote: "Don't skip leg day. It's the foundation of a strong body.", exercises: [{ name: 'Barbell Squats', sets: 4, reps: 8 }, { name: 'Romanian Deadlifts', sets: 3, reps: 10 }, { name: 'Leg Press', sets: 3, reps: 12 }, { name: 'Calf Raises', sets: 4, reps: 15 }], meals: { breakfast: 'Cottage cheese (1 cup) + pineapple + flax seeds.', lunch: 'Leftover chicken + green beans + sweet potato.', dinner: 'Lentil soup (1.5 cups) + mixed greens salad.', snacks: 'Optional: Small protein shake post-workout.' } },
            { title: 'Arm Day', type: 'strength', quote: "Strive for progress, not perfection.", exercises: [{ name: 'Barbell Curls', sets: 3, reps: 10 }, { name: 'Triceps Pushdowns', sets: 3, reps: 10 }, { name: 'Hammer Curls', sets: 3, reps: 12 }, { name: 'Overhead Triceps Extension', sets: 3, reps: 12 }], meals: { breakfast: 'Protein smoothie: almond milk + spinach + banana.', lunch: 'Tuna salad on whole-grain bread + carrot sticks.', dinner: 'Baked chicken thighs (5 oz) + Brussels sprouts.', snacks: 'N/A (Focus on water/herbal tea if hungry)' } },
            { title: 'Recovery Session', type: 'recovery', quote: "Recovery is just as important as the workout itself.", description: 'Sauna or Steam room session for 15-20 minutes.', meals: { breakfast: '2 boiled eggs + 1/2 cup berries + almonds.', lunch: 'Leftover chicken + Brussels sprouts.', dinner: 'White fish (5-6 oz) + broccoli + brown rice.', snacks: 'Optional: Small protein shake post-workout.' } },
            { title: 'Rest Day', type: 'rest', quote: "A day of rest is a part of your training.", description: 'Full rest. Focus on nutrition and hydration.', meals: { breakfast: 'Greek yogurt + granola + raspberries.', lunch: 'Shrimp salad (4-5 oz) + mixed greens + avocado.', dinner: 'Beef stir-fry (5 oz) + mixed vegetables + cauliflower rice.', snacks: 'N/A (Focus on water/herbal tea if hungry)' } },
            { title: 'Full Body Strength', type: 'strength', quote: "You don't have to be extreme, just consistent.", exercises: [{ name: 'Squats', sets: 3, reps: 10 }, { name: 'Bench Press', sets: 3, reps: 10 }, { name: 'Rows', sets: 3, reps: 10 }], meals: { breakfast: '2 scrambled eggs + black beans + salsa.', lunch: 'Leftover beef stir-fry + cauliflower rice.', dinner: 'Baked salmon (4-5 oz) + asparagus + sweet potato.', snacks: 'N/A (Focus on water/herbal tea if hungry)' } },
            { title: 'HIIT Cardio', type: 'cardio', quote: "If it doesn't challenge you, it doesn't change you.", description: '20 minutes of High-Intensity Interval Training.', meals: { breakfast: 'Oatmeal + protein + walnuts + blueberries.', lunch: 'Chicken salad + chickpeas + balsamic vinaigrette.', dinner: 'Turkey meatballs (5 oz) + zucchini noodles + sauce.', snacks: 'Optional: Small protein shake post-workout.' } },
            { title: 'Chest & Back (Supersets)', type: 'strength', quote: "Push yourself because no one else is going to do it for you.", exercises: [{ name: 'Incline Press + T-Bar Row', sets: 3, reps: 10 }, { name: 'Push-ups + Dumbbell Pullovers', sets: 3, reps: 12 }], meals: { breakfast: 'Greek yogurt + mixed berries + flax seeds.', lunch: 'Leftover turkey meatballs + zucchini noodles.', dinner: 'Chicken breast (5 oz) + roasted vegetables.', snacks: 'N/A (Focus on water/herbal tea if hungry)' } },
        ];

        // Function to render the health plan dynamically
        async function renderHealthPlan() {
            healthPlanContainer.innerHTML = ''; // Clear existing cards
            
            // Crucial fix: Ensure startDate is parsed correctly as local date
            const startDate = new Date(startDatePicker.value + 'T00:00:00'); 
            
            for (let i = 0; i < healthPlanTemplate.length; i++) {
                const dayTemplate = healthPlanTemplate[i];
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + i); // Add days based on index

                const formattedDate = currentDate.toLocaleDateString(undefined, { month: 'long', day: 'numeric' });
                const dayOfWeek = currentDate.toLocaleDateString(undefined, { weekday: 'long' });

                const cardId = `${currentDate.toISOString().split('T')[0]}_${i}`; // Unique ID:YYYY-MM-DD_index
                
                let cardContent = '';

                if (dayTemplate.quote) cardContent += `<p class="quote-of-the-day">“${dayTemplate.quote}”</p>`;
                
                if (dayTemplate.meals) {
                    cardContent += `<button class="food-toggle">Food Plan</button><div class="food-plan"><ul class="meal-list">`;
                    for (const mealType of ['breakfast', 'lunch', 'dinner', 'snacks']) {
                        if (dayTemplate.meals[mealType]) {
                            const mealUniqueId = `${cardId}-meal-${mealType}`;
                            cardContent += `
                                <li class="meal-item">
                                    <span class="meal-desc"><strong>${mealType.charAt(0).toUpperCase() + mealType.slice(1)}:</strong> ${dayTemplate.meals[mealType]}</span>
                                    <div class="meal-controls">
                                        <input type="time" id="${mealUniqueId}-time">
                                        <label class="custom-checkbox"><input type="checkbox" id="${mealUniqueId}-check"><span class="checkmark"></span></label>
                                    </div>
                                </li>`;
                        }
                    }
                    cardContent += `</ul></div>`;
                }

                if (dayTemplate.description) cardContent += `<p class="card-text">${dayTemplate.description}</p>`;

                if (dayTemplate.type === 'strength' && dayTemplate.exercises && dayTemplate.exercises.length > 0) {
                    cardContent += '<ul class="exercise-list">';
                    dayTemplate.exercises.forEach((ex, exIndex) => {
                        const exerciseUniqueId = `${cardId}-ex-${exIndex}`; // Unique ID for exercise
                        cardContent += `<li class="exercise-item"><span class="exercise-name">${ex.name} (${ex.sets} sets of ${ex.reps})</span>`;
                        for (let j = 1; j <= ex.sets; j++) {
                            cardContent += `<label class="custom-checkbox"><input type="checkbox" id="${exerciseUniqueId}-set${j}"><span class="checkmark"></span>Set ${j}</label>`;
                        }
                        cardContent += '</li>';
                    });
                    cardContent += '</ul><div class="progress-bar-container"><div class="progress-bar"></div></div>';
                } else if (dayTemplate.type !== 'strength') {
                    cardContent += `<label class="custom-checkbox" style="font-size: 1.1rem; margin-top: 15px;"><input type="checkbox" id="${cardId}-completed"><span class="checkmark"></span>Mark as Completed</label>`;
                }
                
                const timerHtml = `<div class="timer"><div class="timer-display">00:00:00</div><div class="timer-controls"><button class="start-btn">Start</button><button class="pause-btn">Pause</button><button class="reset-btn">Reset</button></div></div>`;
                
                const card = document.createElement('div');
                card.className = 'day-card';
                card.id = cardId; // Use the dynamically generated unique ID
                card.dataset.date = currentDate.toISOString().split('T')[0]; // Store full ISO date for consistent comparison
                card.dataset.type = dayTemplate.type;
                card.innerHTML = `<div class="card-header"><h3>${dayOfWeek}, ${formattedDate}: ${dayTemplate.title}</h3></div><div class="card-body">${cardContent}</div>${timerHtml}`;
                healthPlanContainer.appendChild(card);
            }

            // After all cards are rendered, load their saved states and apply event listeners
            await loadAndApplyCardStates();
            applyEventListenersToCards(); // Re-apply event listeners after cards are rendered
            checkMissedWorkouts();
        }

        // --- LOAD AND APPLY CARD STATES FROM FIREBASE ---
        async function loadAndApplyCardStates() {
            const allCards = document.querySelectorAll('.day-card');
            for (const card of allCards) {
                const cardId = card.id;
                const savedData = await loadCardStateFromFirestore(cardId);
                
                if (savedData) {
                    // Apply checkbox states
                    for (const id in savedData.checkboxes || {}) {
                        const checkbox = document.getElementById(id);
                        if (checkbox) checkbox.checked = savedData.checkboxes[id];
                    }
                    // Apply time input values
                    for (const id in savedData.times || {}) {
                        const timeInput = document.getElementById(id);
                        if (timeInput) timeInput.value = savedData.times[id];
                    }
                    // Apply timer elapsed time
                    const timerUniqueId = `timer-${cardId}`;
                    if (savedData.timers && savedData.timers[timerUniqueId] !== undefined) {
                        const timerDisplay = card.querySelector('.timer-display');
                        const elapsedTime = parseInt(savedData.timers[timerUniqueId] || '0');
                        timerDisplay.textContent = formatTime(elapsedTime);
                        // Store it temporarily in dataset for timer initialization
                        card.dataset.elapsedTime = elapsedTime; 
                    }
                }
                updateCardState(card); // Update UI (progress bars, completed classes) based on loaded state
            }
        }


        // --- EVENT LISTENERS & STATE MANAGEMENT ---
        function applyEventListenersToCards() {
            // Food toggle buttons
            document.querySelectorAll('.food-toggle').forEach(button => {
                button.addEventListener('click', () => {
                    const content = button.nextElementSibling;
                    content.style.display = content.style.display === 'block' ? 'none' : 'block';
                });
            });

            // Checkboxes and Time inputs (save to Firestore on change)
            document.querySelectorAll('.day-card input[type="checkbox"], .day-card input[type="time"]').forEach(input => {
                input.addEventListener('change', function() {
                    const card = this.closest('.day-card');
                    const cardId = card.id;
                    const fieldId = this.id;
                    
                    let dataToSave = {};
                    if (this.type === 'checkbox') {
                        dataToSave = { checkboxes: { [fieldId]: this.checked } };
                    } else if (this.type === 'time') {
                        dataToSave = { times: { [fieldId]: this.value } };
                    }
                    saveCardStateToFirestore(cardId, dataToSave);
                    if(this.type === 'checkbox') updateCardState(card);
                });
            });
            
            // Initialize timers for each card
            document.querySelectorAll('.day-card').forEach(card => {
                initializeTimer(card); // Ensure this is called after data is loaded and elements exist
            });
        }

        // Helper function to format time (used by timers)
        const formatTime = (seconds) => {
            const h = Math.floor(seconds / 3600).toString().padStart(2, '0');
            const m = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
            const s = (seconds % 60).toString().padStart(2, '0');
            return `${h}:${m}:${s}`;
        }

        let runningTimers = {}; // Object to store interval IDs for each card's timer

        function initializeTimer(card) {
            const timerDisplay = card.querySelector('.timer-display');
            const startBtn = card.querySelector('.start-btn');
            const pauseBtn = card.querySelector('.pause-btn');
            const resetBtn = card.querySelector('.reset-btn');
            const cardId = card.id;
            const timerUniqueId = `timer-${cardId}`;
            
            // Get initial elapsed time from dataset (set during loadAndApplyCardStates) or 0
            let elapsedTime = parseInt(card.dataset.elapsedTime || '0');
            
            // Clear any existing interval for this timer to prevent duplicates if renderHealthPlan is called again
            if (runningTimers[timerUniqueId]) {
                clearInterval(runningTimers[timerUniqueId]);
                delete runningTimers[timerUniqueId];
            }
            
            timerDisplay.textContent = formatTime(elapsedTime);

            // Function to start the timer
            const startTimer = () => { 
                if (runningTimers[timerUniqueId]) return; // Already running
                runningTimers[timerUniqueId] = setInterval(() => {
                    elapsedTime++;
                    timerDisplay.textContent = formatTime(elapsedTime);
                    // Save timer state to Firestore periodically (or more frequently if needed)
                    saveCardStateToFirestore(cardId, { timers: { [timerUniqueId]: elapsedTime } });
                }, 1000);
                pauseBtn.classList.add('running');
                pauseBtn.textContent = 'Pause';
            };

            // Function to pause/resume the timer
            const togglePauseResumeTimer = () => {
                if (runningTimers[timerUniqueId]) { // If currently running (pause it)
                    clearInterval(runningTimers[timerUniqueId]);
                    delete runningTimers[timerUniqueId];
                    pauseBtn.classList.remove('running');
                    pauseBtn.textContent = 'Resume';
                } else { // If currently paused (resume it)
                    startTimer(); // Simply call start to resume
                }
                saveCardStateToFirestore(cardId, { timers: { [timerUniqueId]: elapsedTime } });
            };

            // Function to reset the timer
            const resetTimer = () => {
                clearInterval(runningTimers[timerUniqueId]);
                delete runningTimers[timerUniqueId];
                elapsedTime = 0;
                timerDisplay.textContent = formatTime(elapsedTime);
                pauseBtn.classList.remove('running');
                pauseBtn.textContent = 'Pause';
                saveCardStateToFirestore(cardId, { timers: { [timerUniqueId]: elapsedTime } });
            };

            // Attach event listeners
            startBtn.addEventListener('click', startTimer);
            pauseBtn.addEventListener('click', togglePauseResumeTimer);
            resetBtn.addEventListener('click', resetTimer);
        }
        
        // Updates progress bars, completed classes, and checks for missed workouts
        function updateCardState(card) {
            if (!card) return;
            const progressBar = card.querySelector('.progress-bar');
            if (progressBar) {
                const exCheckboxes = card.querySelectorAll('.exercise-item input[type="checkbox"]');
                const checkedCount = card.querySelectorAll('.exercise-item input[type="checkbox"]:checked').length;
                progressBar.style.width = exCheckboxes.length > 0 ? (checkedCount / exCheckboxes.length) * 100 + '%' : '0%';
                exCheckboxes.forEach(cb => {
                    const item = cb.closest('.exercise-item');
                    const allSets = item.querySelectorAll('input[type="checkbox"]');
                    // Ensure the exercise item is marked completed only if ALL its sets are checked
                    item.classList.toggle('completed', Array.from(allSets).every(set => set.checked));
                });
            }
            
            // Check if the entire card (day) is completed
            const allCheckboxesInCard = card.querySelectorAll('.custom-checkbox input');
            card.classList.toggle('completed-day', Array.from(allCheckboxesInCard).every(cb => cb.checked));
            checkMissedWorkouts();
        }

        // Checks for and displays missed workouts
        function checkMissedWorkouts() {
            missedWorkoutsList.innerHTML = '';
            const today = new Date();
            today.setHours(0,0,0,0); // Normalize today's date to start of day
            
            document.querySelectorAll('.day-card').forEach(card => {
                const cardDate = new Date(card.dataset.date); // Use ISO date from dataset
                cardDate.setHours(0,0,0,0); // Normalize card date to start of day

                const isMissed = (cardDate < today) && !card.classList.contains('completed-day');
                card.classList.toggle('missed-day', isMissed);
                
                if (isMissed) {
                    const li = document.createElement('li');
                    li.textContent = `${card.querySelector('h3').textContent.split(': ')[0]}: ${card.querySelector('h3').textContent.split(': ')[1]}`;
                    missedWorkoutsList.appendChild(li);
                }
            });
            if(missedWorkoutsList.children.length === 0) {
                 const li = document.createElement('li');
                 li.textContent = "No missed entries. Great job!";
                 missedWorkoutsList.appendChild(li);
            }
        }
    });
    </script>
</body>
</html>