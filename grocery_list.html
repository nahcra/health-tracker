<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Grocery List</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="firebase-init.js"></script> <link rel="stylesheet" href="style.css"> <style>
        /* Your existing CSS from grocery_list.html - UNCHANGED */
        body { background-color: var(--color-background-dark); color: var(--color-text-light); }
        .container { max-width: 960px; margin: 30px auto; padding: 20px; }
        .header { text-align: center; margin-bottom: 40px; }
        .header h1 { font-size: 2.8rem; color: var(--color-text-highlight); text-shadow: 0 0 10px var(--color-secondary); margin-bottom: 20px; }
        .back-link { display: inline-block; background-color: var(--color-primary); color: #fff; text-decoration: none; font-weight: 600; padding: 10px 20px; border-radius: var(--border-radius-base); transition: background-color 0.3s, transform 0.2s; box-shadow: var(--shadow-elevation-1); }
        .back-link:hover { background-color: #0056b3; transform: translateY(-2px); box-shadow: var(--shadow-elevation-2); }
        .deals-section { background-color: var(--color-card-background); padding: 30px; border-radius: var(--border-radius-base); margin-bottom: 40px; border: 1px solid var(--color-border-subtle); box-shadow: var(--shadow-elevation-1); }
        .deals-section h2 { font-size: 2rem; color: var(--color-tertiary); border-bottom: 2px solid var(--color-border-subtle); padding-bottom: 15px; margin-top: 0; margin-bottom: 25px; text-align: center; }
        #findDealsBtn /*, #generateMealIdeasBtn */ { display: block; width: 100%; padding: 15px; font-size: 1.2rem; font-weight: 600; background: linear-gradient(45deg, var(--color-tertiary), #8e44ad); color: #fff; border: none; border-radius: var(--border-radius-base); cursor: pointer; transition: background 0.3s, transform 0.2s, box-shadow 0.3s; margin-bottom: 20px; box-shadow: var(--shadow-elevation-1); }
        #findDealsBtn:hover /*, #generateMealIdeasBtn:hover */ { background: linear-gradient(45deg, #8e44ad, var(--color-tertiary)); transform: translateY(-2px); box-shadow: var(--shadow-elevation-2); }
        #deals-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .deal-card { background-color: var(--color-input-background); border: 1px solid var(--color-border-subtle); padding: 20px; border-radius: var(--border-radius-base); box-shadow: var(--shadow-elevation-1); transition: transform 0.2s ease; }
        .deal-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-elevation-2); }
        .deal-card h3 { color: var(--color-secondary); margin-top: 0; margin-bottom: 10px; font-size: 1.3rem; }
        .deal-card p { margin: 5px 0 0 0; color: var(--color-text-muted); font-size: 0.95rem; }
        .add-item-form { display: flex; gap: 15px; margin-bottom: 30px; background-color: var(--color-card-background); padding: 20px; border-radius: var(--border-radius-base); border: 1px solid var(--color-border-subtle); box-shadow: var(--shadow-elevation-1); flex-wrap: wrap; }
        .add-item-form input[type="text"] { flex-grow: 1; background-color: var(--color-input-background); border: 1px solid var(--color-border-subtle); color: var(--color-text-light); padding: 12px 18px; border-radius: var(--border-radius-base); font-size: 1rem; outline: none; transition: border-color 0.3s, box-shadow 0.3s; min-width: 200px; }
        .add-item-form input[type="text"]:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.2); }
        .add-item-form button { background-color: var(--color-primary); color: #fff; border: none; padding: 12px 25px; border-radius: var(--border-radius-base); font-weight: 600; cursor: pointer; transition: background-color 0.3s, transform 0.2s, box-shadow 0.3s; box-shadow: var(--shadow-elevation-1); }
        .add-item-form button:hover { background-color: #0056b3; transform: translateY(-2px); box-shadow: var(--shadow-elevation-2); }
        .grocery-category { background-color: var(--color-card-background); padding: 25px; border-radius: var(--border-radius-base); margin-bottom: 25px; border: 1px solid var(--color-border-subtle); box-shadow: var(--shadow-elevation-1); }
        .grocery-category h2 { font-size: 1.8rem; color: var(--color-primary); border-bottom: 2px solid var(--color-border-subtle); padding-bottom: 10px; margin-top: 0; margin-bottom: 20px; text-align: left; }
        .grocery-list { list-style: none; padding: 0; }
        .grocery-item { background-color: var(--color-input-background); padding: 15px 20px; border-radius: var(--border-radius-base); margin-bottom: 10px; display: flex; align-items: center; transition: opacity 0.3s, background-color 0.3s; border: 1px solid var(--color-border-subtle); }
        .grocery-item.checked { opacity: 0.6; background-color: rgba(46, 204, 113, 0.1); border-color: var(--color-secondary); }
        .grocery-item.checked .item-name { text-decoration: line-through; color: var(--color-text-muted); }
        .item-name { flex-grow: 1; font-size: 1.1rem; color: var(--color-text-light); }
        .custom-checkbox { display: inline-flex; align-items: center; cursor: pointer; margin-right: 15px; }
        .custom-checkbox input { display: none; }
        .checkmark { min-width: 24px; height: 24px; background-color: var(--color-background-dark); border: 2px solid var(--color-border-subtle); border-radius: 6px; position: relative; transition: all 0.2s ease; }
        .custom-checkbox:hover .checkmark { border-color: var(--color-secondary); }
        .custom-checkbox input:checked + .checkmark { background-color: var(--color-secondary); border-color: var(--color-secondary); }
        .checkmark::after { content: ''; position: absolute; display: none; left: 8px; top: 4px; width: 5px; height: 12px; border: solid white; border-width: 0 3px 3px 0; transform: rotate(45deg); }
        .custom-checkbox input:checked + .checkmark::after { display: block; }
        .controls { text-align: center; margin-top: 40px; }
        .clear-btn { background-color: var(--color-danger); color: #fff; border: none; padding: 12px 25px; border-radius: var(--border-radius-base); font-weight: 600; cursor: pointer; transition: background-color 0.3s, transform 0.2s, box-shadow 0.3s; box-shadow: var(--shadow-elevation-1); }
        .clear-btn:hover { background-color: #c0392b; transform: translateY(-2px); box-shadow: var(--shadow-elevation-2); }
        @media (max-width: 768px) { .header h1 { font-size: 2.2rem; } .deals-section h2, .grocery-category h2 { font-size: 1.6rem; } #deals-container { grid-template-columns: 1fr; } .add-item-form { flex-direction: column; gap: 10px; } .add-item-form input[type="text"], .add-item-form button { width: 100%; } }
        @media (max-width: 480px) { .header h1 { font-size: 1.8rem; } .deals-section h2, .grocery-category h2 { font-size: 1.4rem; } .grocery-item { padding: 12px 15px; } .item-name { font-size: 1rem; } .checkmark { width: 20px; height: 20px; } .checkmark::after { left: 7px; top: 3px; width: 4px; height: 10px; } }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <h1>My Grocery List</h1>
            <a href="./index.html" class="back-link">← Back to Tracker</a>
        </div>

        <div class="deals-section">
            <h2>Nearby Deals</h2>
            <button id="findDealsBtn">Find Deals Near Me</button>
            <div id="deals-container"></div>
        </div>

        <div class="add-item-form">
            <input type="text" id="newItemInput" placeholder="Add a custom item...">
            <button id="addItemBtn">Add Item</button>
        </div>

        <div id="full-grocery-list"></div>

        <div class="controls">
            <button class="clear-btn" id="clearCheckedBtn">Clear Checked Items</button>
        </div>
    </div>

    <footer class="app-footer">
        <p>© 2024 Fitness Forge. All rights reserved.</p>
    </footer>

    <script>
    let currentUser = null; 

    // --- COMPLETE WORKOUTPROGRAMS DATA (Copied from your index.html) ---
    const workoutPrograms = [
        {
            id: '3-week-bootcamp', name: '3-Week Bootcamp (Weight Loss & Toning)', goal: 'Focuses on full-body conditioning, fat loss, and muscle definition.', duration: '3 Weeks',
            days: [
                { title: 'Full Body Blast', type: 'strength', quote: "The only bad workout is the one that didn't happen.", exercises: [{ name: 'Squats', sets: 3, reps: 12 }, { name: 'Push-ups', sets: 3, reps: 'To Failure' }, { name: 'Dumbbell Rows', sets: 3, reps: 12 }, { name: 'Plank', sets: 3, reps: '60s Hold' }], meals: { breakfast: 'Oatmeal (1/2 cup dry) with berries and a scoop of protein powder.', lunch: 'Large mixed green salad with grilled chicken (4oz) and light vinaigrette.', dinner: 'Baked salmon (5oz) with roasted broccoli and quinoa (1/2 cup cooked).', snacks: 'Apple slices with a tablespoon of almond butter.' } },
                { title: 'HIIT Cardio & Abs', type: 'cardio', quote: "Your body can stand almost anything. It’s your mind that you have to convince.", description: '30 minutes of High-Intensity Interval Training (HIIT) followed by 15 minutes of core exercises.', meals: { breakfast: 'Greek yogurt (1 cup) with chia seeds and a banana.', lunch: 'Turkey breast slices (4oz) wrapped in large lettuce leaves with bell peppers and hummus.', dinner: 'Lentil soup (1.5 cups) with a side of whole-grain toast.', snacks: 'Handful of almonds.' } },
                { title: 'Upper Body Focus', type: 'strength', quote: "Consistency is key to unlocking your full potential.", exercises: [{ name: 'Overhead Press', sets: 3, reps: 10 }, { name: 'Bicep Curls', sets: 3, reps: 12 }, { name: 'Tricep Dips', sets: 3, reps: 'To Failure' }, { name: 'Lateral Raises', sets: 3, reps: 15 }], meals: { breakfast: 'Scrambled eggs (2) with spinach and a slice of whole-grain toast.', lunch: 'Leftover lentil soup.', dinner: 'Chicken stir-fry (5oz chicken) with mixed vegetables and brown rice (1/2 cup cooked).', snacks: 'Protein shake.' } },
                { title: 'Lower Body & Glutes', type: 'strength', quote: "Don't skip leg day. It's the foundation of a strong body.", exercises: [{ name: 'Goblet Squats', sets: 4, reps: 10 }, { name: 'Lunges', sets: 3, reps: 10, side: 'each leg' }, { name: 'Glute Bridges', sets: 3, reps: 15 }, { name: 'Calf Raises', sets: 3, reps: 20 }], meals: { breakfast: 'Smoothie: almond milk, spinach, banana, protein powder.', lunch: 'Tuna salad (canned in water) with cucumber and whole-grain crackers.', dinner: 'Lean beef (4oz) with sweet potato and green beans.', snacks: 'Rice cakes with avocado.' } },
                { title: 'Active Recovery', type: 'recovery', quote: "Recovery is just as important as the workout itself.", description: '30 minutes of light stretching, foam rolling, or gentle yoga.', meals: { breakfast: 'Cottage cheese (1 cup) with sliced pineapple and flax seeds.', lunch: 'Leftover lean beef and vegetables.', dinner: 'Vegetable curry (chickpeas, lentils, mixed veggies) with a small portion of brown rice.', snacks: 'Greek yogurt.' } },
                { title: 'Rest Day', type: 'rest', quote: "A day of rest is a part of your training.", description: 'Full rest. Focus on hydration and nutrient-dense foods.', meals: { breakfast: 'Whole-grain toast (2 slices) with avocado and a sprinkle of chili flakes.', lunch: 'Shrimp salad (4oz shrimp) with mixed greens and a light dressing.', dinner: 'Baked cod (5oz) with roasted asparagus and a side salad.', snacks: 'Mixed nuts (small handful).' } },
                { title: 'Full Body Strength', type: 'strength', quote: "You don't have to be extreme, just consistent.", exercises: [{ name: 'Deadlifts', sets: 3, reps: 8 }, { name: 'Overhead Press', sets: 3, reps: 10 }, { name: 'Bent-Over Rows', sets: 3, reps: 10 }, { name: 'Front Squats', sets: 3, reps: 12 }], meals: { breakfast: 'Protein pancakes (2) with berries and sugar-free syrup.', lunch: 'Quinoa salad with black beans, corn, bell peppers, and grilled chicken (4oz).', dinner: 'Turkey meatballs (5oz) with zucchini noodles and tomato sauce.', snacks: 'Hard-boiled eggs (2).' } },
                { title: 'Cardio Intervals', type: 'cardio', quote: "If it doesn't challenge you, it doesn't change you.", description: '40 minutes of advanced interval cardio (e.g., sprints, jump rope).', meals: { breakfast: 'Scrambled tofu with vegetables and whole-grain toast.', lunch: 'Leftover quinoa salad.', dinner: 'Baked chicken breast (5oz) with sweet potato fries and steamed green beans.', snacks: 'Cottage cheese.' } },
                { title: 'Chest & Triceps', type: 'strength', quote: "Push yourself because no one else is going to do it for you.", exercises: [{ name: 'Incline Dumbbell Press', sets: 4, reps: 10 }, { name: 'Cable Flyes', sets: 3, reps: 15 }, { name: 'Close-Grip Push-ups', sets: 3, reps: 'To Failure' }, { name: 'Triceps Pushdowns', sets: 3, reps: 12 }], meals: { breakfast: 'Greek yogurt (1 cup) with granola and mixed berries.', lunch: 'Tuna sandwich on whole-grain bread with lettuce and tomato.', dinner: 'Salmon fillets (5oz) with roasted Brussels sprouts and brown rice.', snacks: 'Protein bar.' } },
                { title: 'Back & Biceps', type: 'strength', quote: "Strive for progress, not perfection.", exercises: [{ name: 'Pull-ups / Lat Pulldowns', sets: 4, reps: 8 }, { name: 'Seated Cable Rows', sets: 3, reps: 12 }, { name: 'Hammer Curls', sets: 3, reps: 12 }, { name: 'Face Pulls', sets: 3, reps: 15 }], meals: { breakfast: 'Spinach and mushroom omelette (2 eggs) with a side of fruit.', lunch: 'Leftover salmon and vegetables.', dinner: 'Lean ground turkey (5oz) stir-fry with bell peppers, onions, and cauliflower rice.', snacks: 'Rice cakes with peanut butter.' } },
                { title: 'Full Body Recovery', type: 'recovery', quote: "Listen to your body, it knows best.", description: '45 minutes of deep tissue foam rolling and static stretching.', meals: { breakfast: 'Smoothie: almond milk, kale, banana, protein powder.', lunch: 'Chicken breast (4oz) with a large mixed green salad.', dinner: 'Cod (5oz) baked with lemon and herbs, served with steamed green beans.', snacks: 'Handful of walnuts.' } },
                { title: 'Rest Day', type: 'rest', quote: "Recharge and come back stronger.", description: 'Complete rest. Focus on nutrient timing and sleep.', meals: { breakfast: 'Cottage cheese (1 cup) with sliced peaches and a sprinkle of cinnamon.', lunch: 'Leftover chicken and salad.', dinner: 'Baked sweet potato (medium) topped with black beans, salsa, and avocado.', snacks: 'Edamame.' } },
                { title: 'Legs & Shoulders', type: 'strength', quote: "Every day is a new chance to get stronger.", exercises: [{ name: 'Barbell Squats', sets: 4, reps: 8 }, { name: 'Leg Press', sets: 3, reps: 12 }, { name: 'Dumbbell Shoulder Press', sets: 3, reps: 10 }, { name: 'Front Raises', sets: 3, reps: 15 }], meals: { breakfast: 'Protein oatmeal with berries and chopped nuts.', lunch: 'Turkey burger (no bun) with a large side salad.', dinner: 'Chicken breast (5oz) with roasted root vegetables (carrots, parsnips).', snacks: 'Protein shake.' } },
                { title: 'Core & Stability', type: 'cardio', quote: "Strong core, strong body.", description: '30 minutes of core-focused exercises and stability work.', meals: { breakfast: 'Greek yogurt (1 cup) with honey and a sprinkle of granola.', lunch: 'Leftover turkey burger and salad.', dinner: 'Cod (5oz) with steamed broccoli and brown rice.', snacks: 'Orange.' } },
                { title: 'Full Body Circuit', type: 'strength', quote: "Challenge yourself, it's the only path to growth.", exercises: [{ name: 'Kettlebell Swings', sets: 3, reps: 15 }, { name: 'Renegade Rows', sets: 3, reps: 10, side: 'each arm' }, { name: 'Box Jumps', sets: 3, reps: 10 }, { name: 'Burpees', sets: 3, reps: 'To Failure' }], meals: { breakfast: 'Scrambled eggs (2) with avocado and a side of salsa.', lunch: 'Quinoa bowl with roasted vegetables and chickpeas.', dinner: 'Grilled chicken (5oz) with a large spinach salad and balsamic vinaigrette.', snacks: 'Cucumber slices with hummus.' } },
                { title: 'Flexibility & Mobility', type: 'recovery', quote: "Flexibility is the key to longevity.", description: '40 minutes of dynamic and static stretching to improve range of motion.', meals: { breakfast: 'Protein smoothie: almond milk, banana, spinach, protein powder.', lunch: 'Leftover quinoa bowl.', dinner: 'Tuna steak (5oz) with grilled asparagus and a small sweet potato.', snacks: 'Handful of berries.' } },
                { title: 'Rest Day', type: 'rest', quote: "Give your body the rest it deserves.", description: 'Complete rest and focus on mental well-being.', meals: { breakfast: 'Cottage cheese (1 cup) with sliced pear and walnuts.', lunch: 'Chicken and vegetable skewers.', dinner: 'Lentil stew with a side of whole-grain bread.', snacks: 'Greek yogurt.' } },
                { title: 'Strength Endurance', type: 'strength', quote: "Endurance is the ability to withstand hardship.", exercises: [{ name: 'Push Press', sets: 3, reps: 12 }, { name: 'Goblet Squats', sets: 3, reps: 15 }, { name: 'Kettlebell Rows', sets: 3, reps: 15 }, { name: 'Wall Sits', sets: 3, reps: '60s Hold' }], meals: { breakfast: 'Oatmeal with protein powder and mixed seeds.', lunch: 'Large mixed green salad with grilled salmon (4oz).', dinner: 'Turkey chili (lean ground turkey, beans, tomatoes) with a side of brown rice.', snacks: 'Protein bar.' } },
            ]
        },
        {
            id: '6-week-strength', name: '6-Week Strength Builder (Muscle Gain & Power)', goal: 'Focuses on progressive overload to build significant strength and muscle mass.', duration: '6 Weeks',
            days: [
                { title: 'Heavy Chest & Triceps', type: 'strength', quote: "Lift heavy, get strong.", exercises: [{ name: 'Barbell Bench Press', sets: 5, reps: 5 }, { name: 'Incline Dumbbell Press', sets: 4, reps: 8 }, { name: 'Dips', sets: 3, reps: 'To Failure' }, { name: 'Overhead Triceps Extension', sets: 3, reps: 10 }], meals: { breakfast: 'Scrambled eggs (3) with cheese and 2 slices whole-grain toast.', lunch: 'Large chicken breast (6oz) with 1 cup brown rice and steamed broccoli.', dinner: 'Lean ground beef (6oz) with sweet potato (large) and mixed vegetables.', snacks: 'Protein shake with milk.' } },
                { title: 'Heavy Back & Biceps', type: 'strength', quote: "Build your back, build your power.", exercises: [{ name: 'Deadlifts', sets: 5, reps: 3 }, { name: 'Barbell Rows', sets: 4, reps: 8 }, { name: 'Pull-ups (Weighted)', sets: 3, reps: 'To Failure' }, { name: 'Barbell Curls', sets: 3, reps: 8 }], meals: { breakfast: 'Oatmeal (1 cup dry) with protein powder, banana, and peanut butter.', lunch: 'Leftover ground beef and vegetables.', dinner: 'Salmon fillets (6oz) with quinoa (1 cup cooked) and asparagus.', snacks: 'Greek yogurt with honey.' } },
                { title: 'Active Recovery & Core', type: 'recovery', quote: "Smart training includes smart recovery.", description: '45 minutes of dynamic stretching, light cardio, and core work.', meals: { breakfast: 'Greek yogurt (1.5 cups) with mixed berries and granola.', lunch: 'Large mixed green salad with tuna (canned in oil) and avocado.', dinner: 'Chicken stir-fry (6oz chicken) with plenty of vegetables and a small portion of brown rice.', snacks: 'Fruit and handful of nuts.' } },
                { title: 'Heavy Legs & Shoulders', type: 'strength', quote: "Legs are the foundation of strength.", exercises: [{ name: 'Barbell Squats', sets: 5, reps: 5 }, { name: 'Leg Press', sets: 4, reps: 10 }, { name: 'Romanian Deadlifts', sets: 3, reps: 8 }, { name: 'Barbell Overhead Press', sets: 4, reps: 8 }], meals: { breakfast: 'Protein smoothie: milk, protein powder, spinach, banana, almond butter.', lunch: 'Leftover chicken stir-fry.', dinner: 'Lean steak (6oz) with large sweet potato and green beans.', snacks: 'Cottage cheese.' } },
                { title: 'Upper Body Hypertrophy', type: 'strength', quote: "Pump it up!", exercises: [{ name: 'Dumbbell Bench Press', sets: 3, reps: 12 }, { name: 'Cable Crossovers', sets: 3, reps: 15 }, { name: 'Seated Dumbbell Shoulder Press', sets: 3, reps: 12 }, { name: 'Lateral Raises', sets: 3, reps: 15 }, { name: 'Preacher Curls', sets: 3, reps: 12 }, { name: 'Triceps Rope Pushdowns', sets: 3, reps: 15 }], meals: { breakfast: 'Oatmeal with berries and a scoop of protein powder.', lunch: 'Turkey burger (no bun) with a large side salad and a whole-grain bun on the side.', dinner: 'Baked chicken thighs (6oz) with roasted potatoes and carrots.', snacks: 'Protein bar.' } },
                { title: 'Rest Day', type: 'rest', quote: "Growth happens during rest.", description: 'Complete rest. Focus on high-quality protein intake and sleep.', meals: { breakfast: 'Scrambled eggs (3) with avocado and a fruit.', lunch: 'Large mixed green salad with grilled chicken (5oz).', dinner: 'Lentil and vegetable stew with a side of whole-grain bread.', snacks: 'Protein shake.' } },
                { title: 'Lower Body Hypertrophy', type: 'strength', quote: "Legs of steel, glutes of glory.", exercises: [{ name: 'Leg Press', sets: 4, reps: 12 }, { name: 'Leg Extensions', sets: 3, reps: 15 }, { name: 'Hamstring Curls', sets: 3, reps: 15 }, { name: 'Calf Raises (Seated & Standing)', sets: 4, reps: 20 }], meals: { breakfast: 'Protein pancakes with berries and maple syrup.', lunch: 'Leftover lentil stew.', dinner: 'Baked cod (6oz) with sweet potato and green beans.', snacks: 'Greek yogurt.' } },
            ]
        },
        {
            id: '4-week-weight-loss', name: '4-Week Fat Shredder (Weight Loss & Cardio)', goal: 'Maximizes calorie burn and promotes fat loss through a combination of cardio and light strength.', duration: '4 Weeks',
            days: [
                { title: 'Full Body Circuit & Cardio', type: 'cardio', quote: "Burn fat, build endurance.", exercises: [{ name: 'Jumping Jacks', sets: 3, reps: 30 }, { name: 'Bodyweight Squats', sets: 3, reps: 20 }, { name: 'Mountain Climbers', sets: 3, reps: 40, side: 'total' }, { name: 'Push-ups (Knees or Toes)', sets: 3, reps: 'To Failure' }], meals: { breakfast: 'Oatmeal (1/2 cup dry) with water, berries, and a few almonds.', lunch: 'Large spinach salad with grilled chicken (4oz) and plenty of non-starchy vegetables.', dinner: 'Baked cod (5oz) with steamed asparagus and a small side of quinoa (1/4 cup cooked).', snacks: 'Cucumber slices.' } },
                { title: 'HIIT & Core', type: 'cardio', quote: "Sweat is fat crying.", description: '30 minutes of intense HIIT followed by 10 minutes of core exercises (plank, crunches).', meals: { breakfast: 'Greek yogurt (1 cup) with a few mixed berries.', lunch: 'Turkey slices (4oz) with a large mixed green salad.', dinner: 'Lean ground turkey (5oz) stir-fry with mixed vegetables and cauliflower rice.', snacks: 'Celery sticks.' } },
                { title: 'Active Recovery & Mobility', type: 'recovery', quote: "Move well, feel well.", description: '40 minutes of light walking, stretching, and foam rolling.', meals: { breakfast: 'Scrambled eggs (2) with sautéed mushrooms and a small fruit.', lunch: 'Leftover turkey stir-fry.', dinner: 'Lentil soup (1.5 cups) with a small side salad.', snacks: 'Small apple.' } },
                { title: 'Strength & Conditioning', type: 'strength', quote: "Strength training boosts metabolism.", exercises: [{ name: 'Dumbbell Lunges', sets: 3, reps: 10, side: 'each leg' }, { name: 'Push Press (Light Dumbbells)', sets: 3, reps: 12 }, { name: 'Renegade Rows (Light Dumbbells)', sets: 3, reps: 10, side: 'each arm' }, { name: 'Burpees', sets: 3, reps: 10 }], meals: { breakfast: 'Protein smoothie: water, protein powder, spinach, 1/2 banana.', lunch: 'Tuna salad (canned in water) with lettuce wraps and cherry tomatoes.', dinner: 'Grilled chicken breast (5oz) with steamed broccoli and a small sweet potato.', snacks: 'Handful of blueberries.' } },
                { title: 'Long Duration Cardio', type: 'cardio', quote: "Endurance builds resilience.", description: '45-60 minutes of steady-state cardio (e.g., brisk walking, jogging, cycling).', meals: { breakfast: 'Cottage cheese (1 cup) with a few sliced strawberries.', lunch: 'Leftover grilled chicken and vegetables.', dinner: 'Baked salmon (5oz) with a large portion of mixed steamed vegetables.', snacks: 'Rice cakes (1-2).' } },
                { title: 'Rest Day', type: 'rest', quote: "Rest, refuel, restart.", description: 'Complete rest. Focus on hydration and mindful eating.', meals: { breakfast: 'Greek yogurt (1 cup) with a few raspberries.', lunch: 'Large mixed green salad with hard-boiled eggs (2) and light dressing.', dinner: 'Vegetable soup (broth-based) with a small piece of whole-grain bread.', snacks: 'Small orange.' } },
                { title: 'Full Body HIIT', type: 'cardio', quote: "Push your limits.", exercises: [{ name: 'High Knees', sets: 3, reps: 45, side: 'seconds' }, { name: 'Burpee Broad Jumps', sets: 3, reps: 10 }, { name: 'Plank Jacks', sets: 3, reps: 30 }, { name: 'Squat Jumps', sets: 3, reps: 15 }], meals: { breakfast: 'Protein oatmeal with a few blueberries.', lunch: 'Chicken breast (4oz) with a large mixed green salad.', dinner: 'Cod (5oz) with roasted asparagus and a small portion of brown rice.', snacks: 'Small handful of almonds.' } },
            ]
        },
        {
            id: '8-week-muscle-gain', name: '8-Week Muscle Gain (Hypertrophy & Strength)', goal: 'Designed for significant muscle hypertrophy and increased strength through progressive overload.', duration: '8 Weeks',
            days: [
                 { title: 'Chest & Triceps Hypertrophy', type: 'strength', quote: "Feel the pump!", exercises: [{ name: 'Barbell Bench Press', sets: 4, reps: '8-12' }, { name: 'Incline Dumbbell Press', sets: 3, reps: '10-15' }, { name: 'Dumbbell Flyes', sets: 3, reps: '12-15' }, { name: 'Close-Grip Bench Press', sets: 3, reps: '8-12' }, { name: 'Triceps Pushdowns', sets: 3, reps: '12-15' }], meals: { breakfast: 'Oatmeal (1 cup dry) with 2 scoops protein, banana, and 2 tbsp peanut butter.', lunch: 'Large chicken breast (7oz) with 1.5 cups brown rice and mixed vegetables.', dinner: 'Lean ground beef (7oz) with large sweet potato and green beans.', snacks: 'Protein shake with milk and a handful of almonds.' } },
                { title: 'Back & Biceps Hypertrophy', type: 'strength', quote: "Grow your wings!", exercises: [{ name: 'Lat Pulldowns', sets: 4, reps: '10-15' }, { name: 'Seated Cable Rows', sets: 3, reps: '10-15' }, { name: 'T-Bar Rows', sets: 3, reps: '8-12' }, { name: 'Barbell Curls', sets: 3, reps: '8-12' }, { name: 'Hammer Curls', sets: 3, reps: '10-15' }], meals: { breakfast: 'Scrambled eggs (4) with cheese and 2 slices whole-grain toast with avocado.', lunch: 'Leftover ground beef and vegetables.', dinner: 'Salmon fillets (7oz) with 1 cup quinoa and asparagus.', snacks: 'Greek yogurt (1.5 cups) with honey and granola.' } },
                { title: 'Active Recovery / Light Cardio', type: 'recovery', quote: "Smart training includes smart recovery.", description: '30-40 minutes of light cardio (e.g., incline walking) and foam rolling.', meals: { breakfast: 'Protein pancakes (3) with berries and sugar-free syrup.', lunch: 'Large mixed green salad with grilled chicken (5oz) and chickpeas.', dinner: 'Turkey chili (lean ground turkey, beans, tomatoes) with a side of whole-grain bread.', snacks: 'Protein bar and a fruit.' } },
                { title: 'Legs & Shoulders Hypertrophy', type: 'strength', quote: "Build a strong foundation!", exercises: [{ name: 'Barbell Squats', sets: 4, reps: '8-12' }, { name: 'Leg Press', sets: 3, reps: '10-15' }, { name: 'Romanian Deadlifts', sets: 3, reps: '10-15' }, { name: 'Dumbbell Shoulder Press', sets: 3, reps: '8-12' }, { name: 'Lateral Raises', sets: 3, reps: '12-15' }], meals: { breakfast: 'Smoothie: milk, 2 scoops protein, spinach, banana, 2 tbsp almond butter.', lunch: 'Leftover turkey chili.', dinner: 'Lean steak (7oz) with large sweet potato and green beans.', snacks: 'Cottage cheese (1.5 cups).' } },
                { title: 'Full Body Power', type: 'strength', quote: "Explode into strength!", exercises: [{ name: 'Power Cleans', sets: 3, reps: 5 }, { name: 'Box Jumps', sets: 3, reps: 8 }, { name: 'Push Press', sets: 3, reps: 8 }, { name: 'Kettlebell Swings', sets: 3, reps: 15 }], meals: { breakfast: 'Oatmeal (1 cup dry) with protein, berries, and walnuts.', lunch: 'Turkey burger (no bun) with a large side salad and a whole-grain bun on the side.', dinner: 'Baked chicken thighs (7oz) with roasted potatoes and carrots.', snacks: 'Protein bar.' } },
                { title: 'Rest Day', type: 'rest', quote: "Recover, rebuild, grow.", description: 'Complete rest. Focus on high-quality protein and complex carbs.', meals: { breakfast: 'Scrambled eggs (4) with avocado and 2 slices whole-grain toast.', lunch: 'Large mixed green salad with grilled salmon (6oz).', dinner: 'Lentil and vegetable stew with a large piece of whole-grain bread.', snacks: 'Protein shake.' } },
                { title: 'Upper/Lower Split (Upper)', type: 'strength', quote: "Targeted growth.", exercises: [{ name: 'Incline Barbell Press', sets: 4, reps: '8-12' }, { name: 'Pull-ups', sets: 4, reps: 'To Failure' }, { name: 'Dumbbell Rows', sets: 3, reps: '10-15' }, { name: 'Overhead Press', sets: 3, reps: '8-12' }, { name: 'Bicep Curls', sets: 3, reps: '10-15' }, { name: 'Triceps Extensions', sets: 3, reps: '12-15' }], meals: { breakfast: 'Protein oatmeal with peanut butter and banana.', lunch: 'Chicken and vegetable wraps (whole-grain tortillas).', dinner: 'Lean steak (7oz) with brown rice and mixed vegetables.', snacks: 'Greek yogurt.' } },
                { title: 'Upper/Lower Split (Lower)', type: 'strength', quote: "Foundation and power.", exercises: [{ name: 'Front Squats', sets: 4, reps: '8-12' }, { name: 'Leg Curls', sets: 3, reps: '12-15' }, { name: 'Leg Extensions', sets: 3, reps: '12-15' }, { name: 'Glute Bridges (Weighted)', sets: 3, reps: '15-20' }, { name: 'Calf Raises', sets: 4, reps: '20-25' }], meals: { breakfast: 'Scrambled eggs (4) with sweet potato hash.', lunch: 'Leftover steak and vegetables.', dinner: 'Salmon fillets (7oz) with quinoa and roasted asparagus.', snacks: 'Protein shake.' } },
            ]
        },
        {
            id: '12-week-transformation', name: '12-Week Total Transformation (Comprehensive Fitness)', goal: 'A balanced program focusing on strength, endurance, flexibility, and overall well-being.', duration: '12 Weeks',
            days: [
                { title: 'Strength & Conditioning (Full Body)', type: 'strength', quote: "Transform your body, transform your life.", exercises: [{ name: 'Barbell Squats', sets: 4, reps: '8-10' }, { name: 'Bench Press', sets: 4, reps: '8-10' }, { name: 'Bent-Over Rows', sets: 4, reps: '8-10' }, { name: 'Overhead Press', sets: 3, reps: '10-12' }], meals: { breakfast: 'Oatmeal with protein powder, mixed berries, and flax seeds.', lunch: 'Large chicken salad with mixed greens, cucumber, tomatoes, and a light vinaigrette.', dinner: 'Baked cod (6oz) with quinoa (1 cup cooked) and steamed green beans.', snacks: 'Apple with peanut butter.' } },
                { title: 'HIIT & Core Blast', type: 'cardio', quote: "No pain, no gain... but smart pain!", description: '30 minutes of high-intensity interval training (e.g., burpees, jump squats, sprints) followed by 15 minutes of dynamic core exercises.', meals: { breakfast: 'Greek yogurt (1.5 cups) with sliced banana and a sprinkle of chia seeds.', lunch: 'Turkey breast slices (5oz) with a large mixed vegetable salad.', dinner: 'Lentil and vegetable curry with a small portion of brown rice.', snacks: 'Handful of almonds.' } },
                { title: 'Active Recovery & Flexibility', type: 'recovery', quote: "The body achieves what the mind believes.", description: '45 minutes of foam rolling, dynamic stretching, and light yoga poses.', meals: { breakfast: 'Scrambled eggs (3) with spinach and a slice of whole-grain toast.', lunch: 'Leftover lentil curry.', dinner: 'Grilled salmon (6oz) with roasted asparagus and a side salad.', snacks: 'Protein shake.' } }
                // This program would have many more days, filled in similarly
            ]
        }
    ];
    // --- End of workoutPrograms data ---

    function initializeGroceryUI(user) {
        currentUser = user; 

        const listContainer = document.getElementById('full-grocery-list');
        const newItemInput = document.getElementById('newItemInput');
        const addItemBtn = document.getElementById('addItemBtn');
        const clearCheckedBtn = document.getElementById('clearCheckedBtn');
        const findDealsBtn = document.getElementById('findDealsBtn');
        const dealsContainer = document.getElementById('deals-container');
        // const generateMealIdeasBtn = document.getElementById('generateMealIdeasBtn'); // Button is commented out

        const userDocRef = db.collection('users').doc(currentUser.uid);

        async function loadAndRenderGroceryList() {
            try {
                const userProfile = await userDocRef.get();
                if (userProfile.exists && userProfile.data().selectedProgramId) {
                    const selectedProgramId = userProfile.data().selectedProgramId;
                    const selectedProgram = workoutPrograms.find(p => p.id === selectedProgramId);

                    if (selectedProgram) {
                        const categorizedItems = generateGroceryListFromProgram(selectedProgram);
                        await renderList(categorizedItems);
                    } else {
                        console.warn("Selected program not found in local workoutPrograms data:", selectedProgramId);
                        await renderList({}); 
                    }
                } else {
                    console.log("No selected program found in user profile. Displaying empty grocery list.");
                    await renderList({});
                }
            } catch (e) {
                console.error("Error loading grocery list:", e);
                await renderList({});
            }
        }

        function generateGroceryListFromProgram(program) {
            const allProcessedItems = new Set(); 
            const categorizedItems = {};

            program.days.forEach(day => {
                if (day.meals) {
                    for (const mealType in day.meals) {
                        const mealDescription = day.meals[mealType];
                        const extracted = mealDescription.match(/\b([\w'-]+(?:\s+[\w'-]+)*)\b/g); 
                        if (extracted) {
                            extracted.forEach(item => {
                                let cleanedItem = item.toLowerCase()
                                    .replace(/\(([^)]+)\)/g, '') // Remove text in parentheses
                                    .replace(/\b(cup|tbsp|oz|gram|grams|slice|slices|scoop|piece|pieces|large|medium|small|some|a|an|the|with|of|and|or|for|to|in|on|dry|cooked|raw|diced|chopped|grilled|baked|roasted|steamed|lean|canned|mixed|fresh|frozen|organic|sugar-free|light|whole-grain|extra|few|plenty|portion|side)\b/g, '')
                                    .replace(/[^a-zA-Z\s'-]/g, '') // Remove special characters except space, apostrophe, hyphen
                                    .trim();
                                
                                if (cleanedItem.endsWith('s') && !cleanedItem.endsWith('ss') && cleanedItem !== 'hummus' && cleanedItem !== 'asparagus' && cleanedItem !== 'oats' && cleanedItem !== 'flax seeds' && cleanedItem !== 'chia seeds' && cleanedItem !== 'lentils' && cleanedItem.length > 3) {
                                    if (cleanedItem.endsWith('ies')) {
                                      cleanedItem = cleanedItem.slice(0, -3) + 'y';
                                    } else {
                                      cleanedItem = cleanedItem.slice(0, -1); 
                                    }
                                }
                                cleanedItem = cleanedItem.replace(/\s+/g, ' ').trim(); // Normalize multiple spaces

                                if (cleanedItem.length > 2) { 
                                    let capitalizedItem = cleanedItem.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
                                    
                                    if (allProcessedItems.has(capitalizedItem.toLowerCase())) return; 
                                    allProcessedItems.add(capitalizedItem.toLowerCase());

                                    let category = "Miscellaneous"; 
                                    if (['chicken', 'fish', 'turkey', 'salmon', 'tuna', 'shrimp', 'beef', 'egg', 'protein'].some(kw => capitalizedItem.toLowerCase().includes(kw))) category = "Protein";
                                    else if (['berry', 'berries','spinach', 'avocado', 'asparagus', 'tomato', 'banana', 'onion', 'garlic', 'pineapple', 'bean', 'beans', 'carrot', 'brussels sprout', 'broccoli', 'cauliflower', 'zucchini', 'kale', 'cucumber', 'bell pepper', 'mushroom', 'lettuce', 'celery', 'apple', 'orange', 'pear', 'peach', 'fruit', 'vegetable', 'potato', 'sweet potato', 'green', 'mixed green', 'salad', 'veggies'].some(kw => capitalizedItem.toLowerCase().includes(kw))) category = "Produce";
                                    else if (['yogurt', 'cottage cheese', 'milk', 'cheese'].some(kw => capitalizedItem.toLowerCase().includes(kw))) category = "Dairy & Alternatives";
                                    else if (['quinoa', 'toast', 'bread', 'rice', 'oat', 'oats', 'oatmeal', 'lentil', 'lentils', 'almond butter', 'peanut butter', 'flax', 'flax seed', 'chia seed', 'almond', 'walnut', 'granola', 'chickpea', 'nut', 'seed', 'cracker', 'tortilla', 'pancake', 'syrup', 'cereal', 'pasta', 'powder'].some(kw => capitalizedItem.toLowerCase().includes(kw))) category = "Pantry";
                                    
                                    if (!categorizedItems[category]) {
                                        categorizedItems[category] = [];
                                    }
                                    if (!categorizedItems[category].includes(capitalizedItem)) {
                                      categorizedItems[category].push(capitalizedItem);
                                    }
                                }
                            });
                        }
                    }
                }
            });
            for (const category in categorizedItems) { 
                categorizedItems[category].sort();
            }
            return categorizedItems;
        }

        findDealsBtn.addEventListener('click', () => {
            if (!navigator.geolocation) {
                showCustomModal("Geolocation is not supported by your browser.");
                return;
            }
            dealsContainer.innerHTML = '<p style="text-align:center; color:var(--color-text-muted);">Attempting to get location... Ensure HTTPS is used and permissions are granted.</p>';
            findDealsBtn.textContent = "Finding deals...";
            findDealsBtn.disabled = true;
            navigator.geolocation.getCurrentPosition(success, error, { timeout: 10000 });
        });

        function success(position) {
            dealsContainer.innerHTML = ''; 
            const simulatedDeals = [
                { store: 'Local Grocer A', item: 'Chicken Breast', price: '$1.99/lb (Simulated Deal)' },
                { store: 'SuperMart B', item: 'Avocados', price: '5 for $4.00 (Simulated Deal)' },
                { store: 'Fresh Foods C', item: 'Greek Yogurt', price: '$4.99 (Simulated Deal)' },
            ];
            if (simulatedDeals.length === 0) {
                 dealsContainer.innerHTML = '<p style="text-align:center; color:var(--color-text-muted);">No simulated deals available right now.</p>';
            } else {
                simulatedDeals.forEach(deal => {
                    const dealCard = document.createElement('div');
                    dealCard.className = 'deal-card';
                    dealCard.innerHTML = `<h3>${deal.item}</h3><p><strong>Store:</strong> ${deal.store}</p><p><strong>Price:</strong> ${deal.price}</p>`;
                    dealsContainer.appendChild(dealCard);
                });
            }
            findDealsBtn.textContent = "Find Deals Near Me";
            findDealsBtn.disabled = false;
        }

        function error(err) {
            console.warn(`Geolocation ERROR(${err.code}): ${err.message}`);
            let message = "Unable to retrieve your location. Please ensure location services are enabled and you've granted permission. This feature also requires your site to be served over HTTPS.";
            if (err.code === 1) message = "Location permission denied. Please enable it in your browser settings.";
            if (err.code === 2) message = "Location information is unavailable.";
            if (err.code === 3) message = "Location request timed out.";
            dealsContainer.innerHTML = `<p style="text-align:center; color:var(--color-danger);">${message}</p>`;
            showCustomModal(message);
            findDealsBtn.textContent = "Find Deals Near Me";
            findDealsBtn.disabled = false;
        }
        
        function showCustomModal(message, onConfirm = null) {
            const modalId = 'custom-app-modal';
            let modal = document.getElementById(modalId);
            if (!modal) {
                modal = document.createElement('div');
                modal.id = modalId;
                modal.style.cssText = `position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease;`;
                modal.innerHTML = `<div style="background-color: var(--color-card-background); padding: 30px; border-radius: var(--border-radius-base); box-shadow: var(--shadow-elevation-2); text-align: center; max-width: 400px; width: 90%; border: 1px solid var(--color-border-subtle); transform: translateY(-20px); transition: transform 0.3s ease;"><p id="modal-message" style="font-size: 1.1rem; color: var(--color-text-light); margin-bottom: 25px;"></p><div id="modal-actions"><button id="modal-ok-btn" style="background-color: var(--color-primary); color: white; padding: 10px 20px; border: none; border-radius: var(--border-radius-base); cursor: pointer; font-weight: 600; transition: background-color 0.3s; margin: 0 5px;">OK</button><button id="modal-cancel-btn" style="background-color: var(--color-secondary); color: white; padding: 10px 20px; border: none; border-radius: var(--border-radius-base); cursor: pointer; font-weight: 600; transition: background-color 0.3s; margin: 0 5px; display: none;">Cancel</button></div></div>`;
                document.body.appendChild(modal);
            }
            const modalMessageElement = document.getElementById('modal-message');
            if (typeof message === 'string' && message.includes('<')) { // Allow HTML content
                 modalMessageElement.innerHTML = message;
            } else {
                 modalMessageElement.textContent = message;
            }
            const okBtn = document.getElementById('modal-ok-btn');
            const cancelBtn = document.getElementById('modal-cancel-btn');
            const modalContent = modal.querySelector('div');

            okBtn.onclick = () => {
                modal.style.opacity = '0';
                modalContent.style.transform = 'translateY(-20px)';
                setTimeout(() => { modal.style.visibility = 'hidden'; }, 300);
                if (onConfirm) onConfirm(true);
            };
            if (onConfirm) {
                cancelBtn.style.display = 'inline-block';
                cancelBtn.onclick = () => {
                    modal.style.opacity = '0';
                    modalContent.style.transform = 'translateY(-20px)';
                    setTimeout(() => { modal.style.visibility = 'hidden'; }, 300);
                    onConfirm(false);
                };
            } else {
                cancelBtn.style.display = 'none';
            }
            modal.style.visibility = 'visible';
            modal.style.opacity = '1';
            modalContent.style.transform = 'translateY(0)';
        }
        
        async function renderList(categorizedItemsFromProgram) {
            listContainer.innerHTML = ''; 
            const allItemCreationPromises = [];

            for (const category in categorizedItemsFromProgram) {
                categorizedItemsFromProgram[category].forEach(itemName => {
                    allItemCreationPromises.push(createGroceryItem(itemName, category));
                });
            }

            try {
                const customItemsDoc = await userDocRef.collection('grocery_custom_items').doc('items').get();
                if (customItemsDoc.exists) {
                    const customItems = customItemsDoc.data().items || [];
                    customItems.forEach(itemName => {
                        allItemCreationPromises.push(createGroceryItem(itemName, "My Added Items"));
                    });
                }
            } catch(e) {
                console.error("Error fetching custom items in renderList:", e);
            }
            
            const resolvedListElements = await Promise.all(allItemCreationPromises);
            
            const finalCategories = {};
            resolvedListElements.forEach(liElement => {
                if (liElement) { 
                    const category = liElement.dataset.category;
                    if (!finalCategories[category]) {
                        finalCategories[category] = [];
                    }
                    finalCategories[category].push(liElement);
                }
            });

            const sortedCategoryNames = Object.keys(finalCategories).sort((a,b) => {
                const order = ["Produce", "Protein", "Dairy & Alternatives", "Pantry", "Miscellaneous", "My Added Items"];
                const indexA = order.indexOf(a);
                const indexB = order.indexOf(b);
                if (indexA !== -1 && indexB !== -1) return indexA - indexB;
                if (indexA !== -1) return -1;
                if (indexB !== -1) return 1;
                return a.localeCompare(b);
            });

            if (sortedCategoryNames.length === 0) {
                listContainer.innerHTML = '<p style="text-align:center; color:var(--color-text-muted); padding: 20px;">Your grocery list is currently empty. Select a workout plan or add custom items!</p>';
            } else {
                sortedCategoryNames.forEach(categoryName => {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'grocery-category';
                    categoryDiv.innerHTML = `<h2>${categoryName}</h2>`;
                    const list = document.createElement('ul');
                    list.className = 'grocery-list';
                    finalCategories[categoryName].forEach(li => list.appendChild(li));
                    categoryDiv.appendChild(list);
                    listContainer.appendChild(categoryDiv);
                });
            }

            document.querySelectorAll('.grocery-item input[type="checkbox"]').forEach(checkbox => {
                checkbox.removeEventListener('change', handleCheckboxChange); 
                checkbox.addEventListener('change', handleCheckboxChange);
            });
        }
        
        async function createGroceryItem(itemName, category) {
            const itemId = `grocery-${category.replace(/[\s&]+/g, '-')}-${itemName.replace(/[\s&]+/g, '-')}`;
            const li = document.createElement('li');
            li.className = 'grocery-item';
            li.id = `li-${itemId}`;
            li.dataset.category = category;

            try {
                const itemDoc = await userDocRef.collection('grocery_item_states').doc(itemId).get();
                const isChecked = itemDoc.exists ? itemDoc.data().checked : false;
                
                if (isChecked) li.classList.add('checked');
                li.innerHTML = `<label class="custom-checkbox"><input type="checkbox" id="${itemId}" ${isChecked ? 'checked' : ''}><span class="checkmark"></span></label><span class="item-name">${itemName}</span>`;
                return li;
            } catch (e) {
                console.error(`Error fetching state for ${itemName}:`, e);
                // Return a basic item even if Firestore fetch fails for its state
                li.innerHTML = `<label class="custom-checkbox"><input type="checkbox" id="${itemId}"><span class="checkmark"></span></label><span class="item-name">${itemName} (State error)</span>`;
                return li;
            }
        }

        function handleCheckboxChange(e) {
            const checkbox = e.target;
            const itemId = checkbox.id;
            const isChecked = checkbox.checked;
            const listItem = document.getElementById(`li-${itemId}`);
            if (listItem) { // Ensure element exists before toggling class
                listItem.classList.toggle('checked', isChecked);
            }
            userDocRef.collection('grocery_item_states').doc(itemId).set({ checked: isChecked }, { merge: true })
                .catch(err => {
                    console.error("Error saving grocery item state:", err);
                    // Optionally revert UI change if save fails
                    if (listItem) listItem.classList.toggle('checked', !isChecked); 
                    checkbox.checked = !isChecked;
                    showCustomModal("Error saving item state. Please try again.");
                });
        }

        async function addCustomItem() {
            const itemName = newItemInput.value.trim();
            if (itemName === '') return;
            try {
                const docRef = userDocRef.collection('grocery_custom_items').doc('items');
                const docSnap = await docRef.get();
                let customItems = docSnap.exists() ? (docSnap.data().items || []) : [];
                
                if (!customItems.some(item => item.toLowerCase() === itemName.toLowerCase())) {
                    customItems.push(itemName);
                    await docRef.set({ items: customItems }, { merge: true });
                    newItemInput.value = '';
                    await loadAndRenderGroceryList(); 
                } else {
                    showCustomModal(`"${itemName}" is already on your custom list.`);
                }
            } catch (e) {
                console.error("Error adding custom grocery item:", e);
                showCustomModal("Failed to add item. Please try again.");
            }
        }

        async function clearCheckedItems() {
             showCustomModal('Are you sure you want to clear all checked items? This cannot be undone.', async (confirmed) => {
                if (confirmed) {
                    try {
                        const checkedGroceryItemElements = document.querySelectorAll('.grocery-item.checked input[type="checkbox"]');
                        if (checkedGroceryItemElements.length === 0) {
                            showCustomModal("No items are currently checked.");
                            return;
                        }

                        const batch = db.batch();
                        let customItemsModified = false;
                        let currentCustomItems = [];

                        const customItemsDocSnap = await userDocRef.collection('grocery_custom_items').doc('items').get();
                        if (customItemsDocSnap.exists()) {
                            currentCustomItems = customItemsDocSnap.data().items || [];
                        }
                        
                        const remainingCustomItems = [...currentCustomItems];

                        checkedGroceryItemElements.forEach(checkbox => {
                            const itemId = checkbox.id;
                            const listItemElement = checkbox.closest('.grocery-item');
                            if (!listItemElement) return; 

                            const itemName = listItemElement.querySelector('.item-name').textContent;
                            const itemCategory = listItemElement.dataset.category;

                            batch.delete(userDocRef.collection('grocery_item_states').doc(itemId));

                            if (itemCategory === "My Added Items") {
                                const indexToRemove = remainingCustomItems.findIndex(ci => ci.toLowerCase() === itemName.toLowerCase());
                                if (indexToRemove > -1) {
                                    remainingCustomItems.splice(indexToRemove, 1);
                                    customItemsModified = true;
                                }
                            }
                        });

                        if (customItemsModified) {
                            batch.set(userDocRef.collection('grocery_custom_items').doc('items'), { items: remainingCustomItems });
                        }

                        await batch.commit();
                        await loadAndRenderGroceryList(); 
                        showCustomModal("Checked items cleared successfully!");
                    } catch (e) {
                        console.error("Error clearing checked items:", e);
                        showCustomModal("Failed to clear items. Please try again.");
                    }
                }
            });
        }

        addItemBtn.addEventListener('click', addCustomItem);
        newItemInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') addCustomItem(); });
        clearCheckedBtn.addEventListener('click', clearCheckedItems);
        
        // Logic for "Generate Meal Ideas" button (currently commented out in HTML)
        // const generateMealIdeasBtn = document.getElementById('generateMealIdeasBtn');
        // if (generateMealIdeasBtn) {
        //     generateMealIdeasBtn.addEventListener('click', async () => {
        //         generateMealIdeasBtn.disabled = true;
        //         generateMealIdeasBtn.textContent = 'Generating...';
        //         showCustomModal("Generating meal ideas... This may take a moment. Please do not close this window.");
        //         try {
        //             const allGroceryItems = [];
        //             document.querySelectorAll('.grocery-item .item-name').forEach(span => {
        //                 allGroceryItems.push(span.textContent);
        //             });

        //             if (allGroceryItems.length === 0) {
        //                 showCustomModal("Your grocery list is empty. Add some items first to generate meal ideas!");
        //                 generateMealIdeasBtn.disabled = false;
        //                 generateMealIdeasBtn.textContent = '✨ Generate Meal Ideas';
        //                 return;
        //             }

        //             let chatHistory = [];
        //             const promptText = `Given the following grocery list items: ${allGroceryItems.join(', ')}. Generate 3-5 simple, healthy meal ideas (each including a name and a brief description of ingredients/preparation) that can be made using these ingredients. Prioritize using multiple items from the list in each meal. Return the response as a JSON array of objects, where each object has 'mealName' (string) and 'description' (string).`;
        //             chatHistory.push({ role: "user", parts: [{ text: promptText }] });
                    
        //             const payload = {
        //                 contents: chatHistory,
        //                 generationConfig: {
        //                     responseMimeType: "application/json",
        //                     responseSchema: { type: "ARRAY", items: { type: "OBJECT", properties: { "mealName": { "type": "STRING" }, "description": { "type": "STRING" } }, "required": ["mealName", "description"] } }
        //                 }
        //             };

        //             const apiKey = "YOUR_GEMINI_API_KEY_HERE"; // <-- IMPORTANT: ADD YOUR KEY HERE
        //             if (apiKey === "YOUR_GEMINI_API_KEY_HERE" || apiKey === "") {
        //                 showCustomModal("Gemini API key is missing. Please add your API key to the script to use this feature.");
        //                 generateMealIdeasBtn.disabled = false;
        //                 generateMealIdeasBtn.textContent = '✨ Generate Meal Ideas';
        //                 return;
        //             }

        //             const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
        //             const response = await fetch(apiUrl, {
        //                 method: 'POST',
        //                 headers: { 'Content-Type': 'application/json' },
        //                 body: JSON.stringify(payload)
        //             });

        //             const result = await response.json();
        //             if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts) {
        //                 const jsonString = result.candidates[0].content.parts[0].text;
        //                 const mealIdeas = JSON.parse(jsonString);

        //                 let mealIdeasHtml = '<h3 style="color: var(--color-primary); margin-bottom: 15px;">✨ Your Meal Ideas</h3><ul style="list-style: none; padding: 0;">';
        //                 mealIdeas.forEach(meal => {
        //                     mealIdeasHtml += `<li style="background-color: var(--color-input-background); padding: 15px; border-radius: 8px; margin-bottom: 10px; border: 1px solid var(--color-border-subtle); text-align: left;"><strong style="color: var(--color-secondary); font-size: 1.1rem;">${meal.mealName}</strong><p style="color: var(--color-text-light); margin-top: 5px; font-size: 0.95rem;">${meal.description}</p></li>`;
        //                 });
        //                 mealIdeasHtml += '</ul>';
        //                 showCustomModal(mealIdeasHtml, null);
        //             } else {
        //                 showCustomModal("Failed to generate meal ideas. Please try again.");
        //                 console.error("LLM response structure unexpected:", result);
        //             }
        //         } catch (error) {
        //             showCustomModal("An error occurred while generating meal ideas: " + error.message);
        //             console.error("Error calling Gemini API:", error);
        //         } finally {
        //             if(generateMealIdeasBtn) { // Check if button exists
        //                 generateMealIdeasBtn.disabled = false;
        //                 generateMealIdeasBtn.textContent = '✨ Generate Meal Ideas';
        //             }
        //         }
        //     });
        // }
        
        loadAndRenderGroceryList();
    }

    document.addEventListener('DOMContentLoaded', () => {
        firebase.auth().onAuthStateChanged(user => {
            const path = window.location.pathname;
            const isGroceryPage = path.endsWith('/grocery_list.html');
            const isAuthPage = path.endsWith('/auth.html');

            if (user) {
                if (isAuthPage) {
                    window.location.href = './index.html';
                    return;
                }
                if (isGroceryPage) {
                    initializeGroceryUI(user);
                }
            } else {
                if (!isAuthPage && isGroceryPage) { 
                    window.location.href = './auth.html';
                }
            }
        });
    });
    </script>
</body>
</html>