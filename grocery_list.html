78% of storage used … If you run out of space, you can't save to Drive, back up Google Photos, or use Gmail.
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Grocery List</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="firebase-init.js"></script>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Your existing CSS is unchanged */
        body { background-color: var(--color-background-dark); color: var(--color-text-light); }
        .container { max-width: 960px; margin: 30px auto; padding: 20px; }
        .header { text-align: center; margin-bottom: 40px; }
        .header h1 { font-size: 2.8rem; color: var(--color-text-highlight); text-shadow: 0 0 10px var(--color-secondary); margin-bottom: 20px; }
        .back-link { display: inline-block; background-color: var(--color-primary); color: #fff; text-decoration: none; font-weight: 600; padding: 10px 20px; border-radius: var(--border-radius-base); transition: background-color 0.3s, transform 0.2s; box-shadow: var(--shadow-elevation-1); }
        .back-link:hover { background-color: #0056b3; transform: translateY(-2px); box-shadow: var(--shadow-elevation-2); }
        .deals-section { background-color: var(--color-card-background); padding: 30px; border-radius: var(--border-radius-base); margin-bottom: 40px; border: 1px solid var(--color-border-subtle); box-shadow: var(--shadow-elevation-1); }
        .deals-section h2 { font-size: 2rem; color: var(--color-tertiary); border-bottom: 2px solid var(--color-border-subtle); padding-bottom: 15px; margin-top: 0; margin-bottom: 25px; text-align: center; }
        #findDealsBtn, #generateMealIdeasBtn { display: block; width: 100%; padding: 15px; font-size: 1.2rem; font-weight: 600; background: linear-gradient(45deg, var(--color-tertiary), #8e44ad); color: #fff; border: none; border-radius: var(--border-radius-base); cursor: pointer; transition: background 0.3s, transform 0.2s, box-shadow 0.3s; margin-bottom: 20px; box-shadow: var(--shadow-elevation-1); }
        #findDealsBtn:hover, #generateMealIdeasBtn:hover { background: linear-gradient(45deg, #8e44ad, var(--color-tertiary)); transform: translateY(-2px); box-shadow: var(--shadow-elevation-2); }
        #deals-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .deal-card { background-color: var(--color-input-background); border: 1px solid var(--color-border-subtle); padding: 20px; border-radius: var(--border-radius-base); box-shadow: var(--shadow-elevation-1); transition: transform 0.2s ease; }
        .deal-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-elevation-2); }
        .deal-card h3 { color: var(--color-secondary); margin-top: 0; margin-bottom: 10px; font-size: 1.3rem; }
        .deal-card p { margin: 5px 0 0 0; color: var(--color-text-muted); font-size: 0.95rem; }
        .add-item-form { display: flex; gap: 15px; margin-bottom: 30px; background-color: var(--color-card-background); padding: 20px; border-radius: var(--border-radius-base); border: 1px solid var(--color-border-subtle); box-shadow: var(--shadow-elevation-1); flex-wrap: wrap; }
        .add-item-form input[type="text"] { flex-grow: 1; background-color: var(--color-input-background); border: 1px solid var(--color-border-subtle); color: var(--color-text-light); padding: 12px 18px; border-radius: var(--border-radius-base); font-size: 1rem; outline: none; transition: border-color 0.3s, box-shadow 0.3s; min-width: 200px; }
        .add-item-form input[type="text"]:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.2); }
        .add-item-form button { background-color: var(--color-primary); color: #fff; border: none; padding: 12px 25px; border-radius: var(--border-radius-base); font-weight: 600; cursor: pointer; transition: background-color 0.3s, transform 0.2s, box-shadow 0.3s; box-shadow: var(--shadow-elevation-1); }
        .add-item-form button:hover { background-color: #0056b3; transform: translateY(-2px); box-shadow: var(--shadow-elevation-2); }
        .grocery-category { background-color: var(--color-card-background); padding: 25px; border-radius: var(--border-radius-base); margin-bottom: 25px; border: 1px solid var(--color-border-subtle); box-shadow: var(--shadow-elevation-1); }
        .grocery-category h2 { font-size: 1.8rem; color: var(--color-primary); border-bottom: 2px solid var(--color-border-subtle); padding-bottom: 10px; margin-top: 0; margin-bottom: 20px; text-align: left; }
        .grocery-list { list-style: none; padding: 0; }
        .grocery-item { background-color: var(--color-input-background); padding: 15px 20px; border-radius: var(--border-radius-base); margin-bottom: 10px; display: flex; align-items: center; transition: opacity 0.3s, background-color 0.3s; border: 1px solid var(--color-border-subtle); }
        .grocery-item.checked { opacity: 0.6; background-color: rgba(46, 204, 113, 0.1); border-color: var(--color-secondary); }
        .grocery-item.checked .item-name { text-decoration: line-through; color: var(--color-text-muted); }
        .item-name { flex-grow: 1; font-size: 1.1rem; color: var(--color-text-light); }
        .custom-checkbox { display: inline-flex; align-items: center; cursor: pointer; margin-right: 15px; }
        .custom-checkbox input { display: none; }
        .checkmark { min-width: 24px; height: 24px; background-color: var(--color-background-dark); border: 2px solid var(--color-border-subtle); border-radius: 6px; position: relative; transition: all 0.2s ease; }
        .custom-checkbox:hover .checkmark { border-color: var(--color-secondary); }
        .custom-checkbox input:checked + .checkmark { background-color: var(--color-secondary); border-color: var(--color-secondary); }
        .checkmark::after { content: ''; position: absolute; display: none; left: 8px; top: 4px; width: 5px; height: 12px; border: solid white; border-width: 0 3px 3px 0; transform: rotate(45deg); }
        .custom-checkbox input:checked + .checkmark::after { display: block; }
        .controls { text-align: center; margin-top: 40px; }
        .clear-btn { background-color: var(--color-danger); color: #fff; border: none; padding: 12px 25px; border-radius: var(--border-radius-base); font-weight: 600; cursor: pointer; transition: background-color 0.3s, transform 0.2s, box-shadow 0.3s; box-shadow: var(--shadow-elevation-1); }
        .clear-btn:hover { background-color: #c0392b; transform: translateY(-2px); box-shadow: var(--shadow-elevation-2); }
        @media (max-width: 768px) { .header h1 { font-size: 2.2rem; } .deals-section h2, .grocery-category h2 { font-size: 1.6rem; } #deals-container { grid-template-columns: 1fr; } .add-item-form { flex-direction: column; gap: 10px; } .add-item-form input[type="text"], .add-item-form button { width: 100%; } }
        @media (max-width: 480px) { .header h1 { font-size: 1.8rem; } .deals-section h2, .grocery-category h2 { font-size: 1.4rem; } .grocery-item { padding: 12px 15px; } .item-name { font-size: 1rem; } .checkmark { width: 20px; height: 20px; } .checkmark::after { left: 7px; top: 3px; width: 4px; height: 10px; } }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <h1>My Grocery List</h1>
            <a href="./index.html" class="back-link">← Back to Tracker</a>
        </div>
        <div class="deals-section">
            <h2>Nearby Deals</h2>
            <button id="findDealsBtn">Find Deals Near Me</button>
            <button id="generateMealIdeasBtn">✨ Generate Meal Ideas</button>
            <div id="deals-container"></div>
        </div>
        <div class="add-item-form">
            <input type="text" id="newItemInput" placeholder="Add a custom item...">
            <button id="addItemBtn">Add Item</button>
        </div>
        <div id="full-grocery-list"></div>
        <div class="controls">
            <button class="clear-btn" id="clearCheckedBtn">Clear Checked Items</button>
        </div>
    </div>

    <footer class="app-footer">
        <p>© 2024 Fitness Forge. All rights reserved.</p>
    </footer>

    <script>
    let currentUser = null; 

    // *** FIX #1: ADDED THE FULL workoutPrograms DATA STRUCTURE HERE ***
    // This data must be available on this page to generate the grocery list.
    // Make sure this matches the workoutPrograms array in your index.html file.
    const workoutPrograms = [
        {
            id: '3-week-bootcamp', name: '3-Week Bootcamp (Weight Loss & Toning)', goal: 'Focuses on full-body conditioning, fat loss, and muscle definition.', duration: '3 Weeks',
            days: [ /* Paste ALL your days for 3-week-bootcamp here from index.html */ ]
        },
        {
            id: '6-week-strength', name: '6-Week Strength Builder (Muscle Gain & Power)', goal: 'Focuses on progressive overload to build significant strength and muscle mass.', duration: '6 Weeks',
            days: [ /* Paste ALL your days for 6-week-strength here from index.html */ ]
        },
        {
            id: '4-week-weight-loss', name: '4-Week Fat Shredder (Weight Loss & Cardio)', goal: 'Maximizes calorie burn and promotes fat loss through a combination of cardio and light strength.', duration: '4 Weeks',
            days: [ /* Paste ALL your days for 4-week-weight-loss here from index.html */ ]
        },
        {
            id: '8-week-muscle-gain', name: '8-Week Muscle Gain (Hypertrophy & Strength)', goal: 'Designed for significant muscle hypertrophy and increased strength through progressive overload.', duration: '8 Weeks',
            days: [ /* Paste ALL your days for 8-week-muscle-gain here from index.html */ ]
        },
        {
            id: '12-week-transformation', name: '12-Week Total Transformation (Comprehensive Fitness)', goal: 'A balanced program focusing on strength, endurance, flexibility, and overall well-being.', duration: '12 Weeks',
            days: [ /* Paste ALL your days for 12-week-transformation here from index.html */ ]
        }
        // Add any other workout programs you have defined in index.html
    ];
    // IMPORTANT: You must copy the *complete* 'days' arrays for each program
    // from your index.html into the placeholders above. For brevity, I've omitted them here.

    function initializeGroceryUI(user) { // Renamed from initializeAppUI
        currentUser = user; 

        const listContainer = document.getElementById('full-grocery-list');
        const newItemInput = document.getElementById('newItemInput');
        const addItemBtn = document.getElementById('addItemBtn');
        const clearCheckedBtn = document.getElementById('clearCheckedBtn');
        const findDealsBtn = document.getElementById('findDealsBtn');
        const dealsContainer = document.getElementById('deals-container');
        const generateMealIdeasBtn = document.getElementById('generateMealIdeasBtn');

        const userDocRef = db.collection('users').doc(currentUser.uid);

        async function loadAndRenderGroceryList() {
            try {
                const userProfile = await userDocRef.get();
                if (userProfile.exists && userProfile.data().selectedProgramId) {
                    const selectedProgramId = userProfile.data().selectedProgramId;
                    const selectedProgram = workoutPrograms.find(p => p.id === selectedProgramId);

                    if (selectedProgram) {
                        const categorizedItems = generateGroceryListFromProgram(selectedProgram);
                        await renderList(categorizedItems);
                    } else {
                        console.warn("Selected program not found in local workoutPrograms data:", selectedProgramId);
                        await renderList({}); // Render an empty list or default
                    }
                } else {
                    console.log("No selected program found in user profile. Displaying empty/default grocery list.");
                    await renderList({}); // Render an empty list or default
                }
            } catch (e) {
                console.error("Error loading user profile or program for grocery list:", e);
                await renderList({});
            }
        }

        // *** RESTORED: Your original detailed parsing logic ***
        function generateGroceryListFromProgram(program) {
            const allItems = new Set(); // To ensure uniqueness before categorization
            const categorizedItems = {};

            program.days.forEach(day => {
                if (day.meals) {
                    for (const mealType in day.meals) {
                        const mealDescription = day.meals[mealType];
                        const extracted = mealDescription.match(/\b([\w'-]+(?:\s+[\w'-]+)*)\b/g); // Improved regex
                        if (extracted) {
                            extracted.forEach(item => {
                                let cleanedItem = item.toLowerCase()
                                    .replace(/\boz\b|\btbsp\b|\bcup\b|\bslices?\b|\bscoop\b|\bdry\b|\bcooked\b|\braw\b|\bdiced\b|\bchopped\b|\bgrilled\b|\bbaked\b|\broasted\b|\bsteamed\b|\blean\b|\bcanned\b|\bmixed\b|\bfresh\b|\bfrozen\b|\borganic\b|\bsugar-free\b|\blight\b|\bwhole-grain\b|\bmedium\b|\blarge\b|\bextra\b|\bfew\b|\bplenty\b|\bsmall\b|\bportion\b|\bside\b/g, '')
                                    .replace(/^(a|an|the|with|of|and|or|for|to)\s/g, '')
                                    .replace(/\s(a|an|the|with|of|and|or|for|to)$/g, '')
                                    .replace(/[()]/g, '') // Remove parentheses
                                    .trim();
                                
                                // Basic plural removal (e.g., eggs -> egg, berries -> berry)
                                if (cleanedItem.endsWith('ies')) {
                                    cleanedItem = cleanedItem.slice(0, -3) + 'y';
                                } else if (cleanedItem.endsWith('s') && !cleanedItem.endsWith('ss') && cleanedItem.length > 3) { // Avoid 'hummus', 'asparagus'
                                    cleanedItem = cleanedItem.slice(0, -1);
                                }

                                if (cleanedItem.length > 2 && !['and', 'or', 'for', 'to', 'in', 'on'].includes(cleanedItem)) {
                                    cleanedItem = cleanedItem.charAt(0).toUpperCase() + cleanedItem.slice(1); // Capitalize
                                    if (allItems.has(cleanedItem)) continue; // Skip if already processed
                                    allItems.add(cleanedItem);

                                    let category = "Miscellaneous";
                                    // Your categorization logic
                                    if (['chicken', 'fish', 'turkey', 'salmon', 'tuna', 'shrimp', 'beef', 'egg', 'protein'].some(kw => cleanedItem.toLowerCase().includes(kw))) category = "Protein";
                                    else if (['berry', 'spinach', 'avocado', 'asparagus', 'tomato', 'banana', 'onion', 'garlic', 'pineapple', 'bean', 'carrot', 'brussels sprout', 'broccoli', 'cauliflower', 'zucchini', 'kale', 'cucumber', 'bell pepper', 'mushroom', 'lettuce', 'celery', 'apple', 'orange', 'pear', 'peach', 'fruit', 'vegetable', 'potato', 'sweet potato'].some(kw => cleanedItem.toLowerCase().includes(kw))) category = "Produce";
                                    else if (['yogurt', 'cottage cheese', 'milk', 'cheese'].some(kw => cleanedItem.toLowerCase().includes(kw))) category = "Dairy & Alternatives";
                                    else if (['quinoa', 'toast', 'bread', 'rice', 'oat', 'oatmeal', 'lentil', 'almond butter', 'peanut butter', 'flax', 'almond', 'walnut', 'granola', 'chickpea', 'nut', 'seed', 'cracker', 'tortilla', 'pancake', 'syrup', 'cereal'].some(kw => cleanedItem.toLowerCase().includes(kw))) category = "Pantry";
                                    
                                    if (!categorizedItems[category]) {
                                        categorizedItems[category] = [];
                                    }
                                    if (!categorizedItems[category].includes(cleanedItem)) {
                                      categorizedItems[category].push(cleanedItem);
                                    }
                                }
                            });
                        }
                    }
                }
            });
            for (const category in categorizedItems) { // Sort items within each category
                categorizedItems[category].sort();
            }
            return categorizedItems;
        }

        findDealsBtn.addEventListener('click', () => {
            if (!navigator.geolocation) {
                showCustomModal("Geolocation is not supported by your browser.");
                return;
            }
            // IMPORTANT: For Geolocation to work, your site MUST be served over HTTPS.
            // It will likely be blocked if you are running from http://localhost or a file:// path.
            findDealsBtn.textContent = "Finding deals...";
            findDealsBtn.disabled = true;
            navigator.geolocation.getCurrentPosition(success, error);
        });

        function success(position) { /* Your existing function logic */ }
        function error() { /* Your existing function logic */ }
        function showCustomModal(message, onConfirm = null) { /* Your existing function logic */ }
        
        async function renderList(categorizedItems) {
            listContainer.innerHTML = ''; // Clear previous list
            const allItemCreationPromises = [];

            // Program-generated items
            for (const category in categorizedItems) {
                categorizedItems[category].forEach(itemName => {
                    allItemCreationPromises.push(createGroceryItem(itemName, category));
                });
            }

            // Custom items from Firestore
            try {
                const customItemsDoc = await userDocRef.collection('grocery_custom_items').doc('items').get();
                if (customItemsDoc.exists) {
                    const customItems = customItemsDoc.data().items || [];
                    customItems.forEach(itemName => {
                        allItemCreationPromises.push(createGroceryItem(itemName, "My Added Items"));
                    });
                }
            } catch(e) {
                console.error("Error fetching custom items in renderList:", e);
            }
            
            const resolvedListElements = await Promise.all(allItemCreationPromises);

            const finalCategories = {};
            resolvedListElements.forEach(liElement => {
                if (liElement) { // Check if liElement is not null/undefined
                    const category = liElement.dataset.category;
                    if (!finalCategories[category]) {
                        finalCategories[category] = [];
                    }
                    finalCategories[category].push(liElement);
                }
            });

            const sortedCategoryNames = Object.keys(finalCategories).sort();

            sortedCategoryNames.forEach(categoryName => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'grocery-category';
                categoryDiv.innerHTML = `<h2>${categoryName}</h2>`;
                const list = document.createElement('ul');
                list.className = 'grocery-list';
                finalCategories[categoryName].forEach(li => list.appendChild(li));
                categoryDiv.appendChild(list);
                listContainer.appendChild(categoryDiv);
            });

            document.querySelectorAll('.grocery-item input[type="checkbox"]').forEach(checkbox => {
                checkbox.removeEventListener('change', handleCheckboxChange); // Prevent multiple listeners
                checkbox.addEventListener('change', handleCheckboxChange);
            });
        }
        
        async function createGroceryItem(itemName, category) { /* Your existing function, unchanged */ return document.createElement('li'); }
        function handleCheckboxChange(e) { /* Your existing function, unchanged */ }

        async function addCustomItem() {
            const itemName = newItemInput.value.trim();
            if (itemName === '') return;
            try {
                const docRef = userDocRef.collection('grocery_custom_items').doc('items');
                const docSnap = await docRef.get();
                let customItems = docSnap.exists() ? (docSnap.data().items || []) : [];
                
                if (!customItems.some(item => item.toLowerCase() === itemName.toLowerCase())) { // Case-insensitive check
                    customItems.push(itemName);
                    await docRef.set({ items: customItems }, { merge: true }); // Use merge if doc might not exist
                    newItemInput.value = '';
                    await loadAndRenderGroceryList(); // Reload the whole list
                } else {
                    showCustomModal(`"${itemName}" is already on your custom list.`);
                }
            } catch (e) {
                console.error("Error adding custom grocery item:", e);
                showCustomModal("Failed to add item. Please try again.");
            }
        }

        function clearCheckedItems() { /* Your existing function, unchanged */ }

        addItemBtn.addEventListener('click', addCustomItem);
        newItemInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') addCustomItem(); });
        clearCheckedBtn.addEventListener('click', clearCheckedItems);

        generateMealIdeasBtn.addEventListener('click', async () => {
            generateMealIdeasBtn.disabled = true;
            generateMealIdeasBtn.textContent = 'Generating...';
            showCustomModal("Generating meal ideas... This may take a moment. Please do not close this window.");

            try {
                const allGroceryItems = [];
                document.querySelectorAll('.grocery-item .item-name').forEach(span => {
                    allGroceryItems.push(span.textContent);
                });

                if (allGroceryItems.length === 0) {
                    showCustomModal("Your grocery list is empty. Add some items first to generate meal ideas!");
                    generateMealIdeasBtn.disabled = false;
                    generateMealIdeasBtn.textContent = '✨ Generate Meal Ideas';
                    return;
                }

                let chatHistory = [];
                const prompt = `Given the following grocery list items: ${allGroceryItems.join(', ')}. Generate 3-5 simple, healthy meal ideas (each including a name and a brief description of ingredients/preparation) that can be made using these ingredients. Prioritize using multiple items from the list in each meal. Return the response as a JSON array of objects, where each object has 'mealName' (string) and 'description' (string).`;

                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = {
                    contents: chatHistory,
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: { type: "ARRAY", items: { type: "OBJECT", properties: { "mealName": { "type": "STRING" }, "description": { "type": "STRING" } }, "required": ["mealName", "description"] } }
                    }
                };

                // *** IMPORTANT: REPLACE "" WITH YOUR ACTUAL GEMINI API KEY ***
                const apiKey = "YOUR_GEMINI_API_KEY_HERE"; // <--- ADD YOUR KEY!
                if (apiKey === "YOUR_GEMINI_API_KEY_HERE" || apiKey === "") {
                    showCustomModal("Gemini API key is missing. Please add your API key to the script.");
                    generateMealIdeasBtn.disabled = false;
                    generateMealIdeasBtn.textContent = '✨ Generate Meal Ideas';
                    return;
                }

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                // ... Rest of your Gemini API call logic (unchanged) ...
            } catch (error) { /* Your existing error handling */ } 
            finally { /* Your existing finally block */ }
        });
        loadAndRenderGroceryList();
    }

    document.addEventListener('DOMContentLoaded', () => {
        firebase.auth().onAuthStateChanged(user => {
            const path = window.location.pathname;
            const isGroceryPage = path.endsWith('/grocery_list.html');
            const isAuthPage = path.endsWith('/auth.html');

            if (user) {
                if (isAuthPage) {
                    window.location.href = './index.html';
                    return;
                }
                if (isGroceryPage) {
                    initializeGroceryUI(user);
                }
            } else {
                if (!isAuthPage) {
                    window.location.href = './auth.html';
                }
            }
        });
    });
    </script>
</body>
</html>