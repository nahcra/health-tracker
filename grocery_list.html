78% of storage used â€¦ If you run out, you can't create, edit, and upload files.
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Check if Firebase is available
    if (typeof firebase === 'undefined' || typeof firebase.auth === 'undefined' || typeof firebase.firestore === 'undefined') {
        console.error("Firebase SDKs not loaded correctly for grocery_list.html. Ensure firebase-config.js is first, then firebase-app.js, firebase-auth.js, and firebase-firestore.js in your HTML head.");
        document.body.innerHTML = "<p style='color:white; text-align:center; padding-top: 50px;'>Error: Application cannot start. Firebase not loaded. Please check console.</p>";
        return;
    }

    const auth = firebase.auth();
    const db = firebase.firestore();
    let currentUserId = null;

    // DOM Elements for grocery list
    const listContainer = document.getElementById('full-grocery-list');
    const newItemInput = document.getElementById('newItemInput');
    const addItemBtn = document.getElementById('addItemBtn');
    const clearCheckedBtn = document.getElementById('clearCheckedBtn');
    const findDealsBtn = document.getElementById('findDealsBtn');
    const dealsContainer = document.getElementById('deals-container');

    // Hide parts of the page initially until auth check is complete
    const mainContentContainer = document.querySelector('.container > .deals-section, .container > .add-item-form, .container > #full-grocery-list, .container > .controls');
    if(mainContentContainer) { // Simple way to hide, or use a wrapper div
       // For simplicity, let's assume the whole body will be shown/hidden based on auth,
       // but a more granular approach might be needed if there are non-auth elements.
    }
    document.body.style.visibility = 'hidden'; // Hide body initially

    auth.onAuthStateChanged(async (user) => {
        if (user) {
            currentUserId = user.uid;
            console.log("Grocery List: User logged in:", currentUserId);
            document.body.style.visibility = 'visible'; // Show content
            await loadGroceryDataFromFirestore(); 
        } else {
            currentUserId = null;
            console.log("Grocery List: User not logged in, redirecting to auth.html");
            // Ensure auth.html is in the same directory or provide correct path
            window.location.replace('./auth.html'); 
        }
    });

    const predefinedGroceryData = { // Renamed to avoid conflict if groceryData is used elsewhere
        "Produce": ["Mixed Berries", "Chia Seeds", "Avocado", "Asparagus", "Mixed Greens / Spinach", "Cherry Tomatoes", "Banana", "Onion & Garlic", "Pineapple", "Green Beans", "Sweet Potato", "Carrots", "Brussels Sprouts", "Broccoli", "Cauliflower", "Zucchini"],
        "Protein (Meat & Seafood)": ["Chicken (breasts & thighs)", "Cod (or other white fish)", "Turkey", "Salmon", "Tuna (canned)", "Shrimp", "Beef", "Eggs"],
        "Dairy & Alternatives": ["Greek Yogurt", "Cottage Cheese", "Almond Milk"],
        "Pantry (Grains, Nuts, Seeds, etc.)": ["Quinoa", "Whole-grain Toast / Bread", "Brown Rice", "Oats", "Lentils", "Almond Butter", "Flax Seeds", "Almonds / Walnuts", "Granola", "Chickpeas", "Black Beans"],
        "Miscellaneous": ["Protein Powder (optional)", "Vinaigrette Dressing", "Herbal Tea", "Salsa", "Tomato Sauce", "Spices (as needed)"]
    };

    async function loadGroceryDataFromFirestore() {
        if (!currentUserId) { 
            renderList([], {}); // Render with empty data if no user (should be redirected anyway)
            return;
        }

        let customItems = [];
        let checkedItemsData = {};

        try {
            const customItemsDocRef = db.collection('users').doc(currentUserId).collection('groceryData').doc('customItems');
            const customItemsSnap = await customItemsDocRef.get();
            if (customItemsSnap.exists() && customItemsSnap.data().items) {
                customItems = customItemsSnap.data().items;
            }

            const checkedItemsDocRef = db.collection('users').doc(currentUserId).collection('groceryData').doc('checkedStates');
            const checkedItemsSnap = await checkedItemsDocRef.get();
            if (checkedItemsSnap.exists()) {
                checkedItemsData = checkedItemsSnap.data();
            }
            console.log("Grocery data loaded from Firestore:", { customItems, checkedItemsData });
        } catch (error) {
            console.error("Error loading grocery data from Firestore:", error);
        }
        renderList(customItems, checkedItemsData);
    }

    async function saveCustomGroceryItemsToFirestore(itemsArray) {
        if (!currentUserId) return;
        try {
            await db.collection('users').doc(currentUserId).collection('groceryData').doc('customItems').set({ items: itemsArray });
            console.log("Custom grocery items saved to Firestore.");
        } catch (error) {
            console.error("Error saving custom grocery items to Firestore:", error);
        }
    }

    async function saveCheckedStateToFirestore(itemId, isChecked) {
        if (!currentUserId) return;
        try {
            const checkedItemsDocRef = db.collection('users').doc(currentUserId).collection('groceryData').doc('checkedStates');
            await checkedItemsDocRef.set({ [itemId]: isChecked }, { merge: true });
            // console.log(`Checked state saved for ${itemId}: ${isChecked}`); // Optional: for less console noise
        } catch (error) {
            console.error("Error saving checked state for " + itemId + " to Firestore:", error);
        }
    }

    function renderList(customItemsArray = [], checkedItemsMap = {}) {
        if (!listContainer) {
            console.error("Grocery list container not found in HTML.");
            return;
        }
        listContainer.innerHTML = ''; 
        
        let itemsRendered = false;

        for (const category in predefinedGroceryData) {
            itemsRendered = true;
            const categoryDiv = document.createElement('div');
            categoryDiv.className = 'grocery-category';
            categoryDiv.innerHTML = `<h2>${category}</h2>`;
            const list = document.createElement('ul');
            list.className = 'grocery-list';
            predefinedGroceryData[category].forEach(item => {
                const itemId = `grocery-${category.replace(/[\s()']/g, '-')}-${item.replace(/[\s()']/g, '-')}`; // Sanitize ID
                list.appendChild(createGroceryItem(item, itemId, checkedItemsMap[itemId] || false));
            });
            categoryDiv.appendChild(list);
            listContainer.appendChild(categoryDiv);
        }

        if (customItemsArray.length > 0) {
            itemsRendered = true;
            const categoryDiv = document.createElement('div');
            categoryDiv.className = 'grocery-category';
            categoryDiv.innerHTML = `<h2>My Added Items</h2>`;
            const list = document.createElement('ul');
            list.className = 'grocery-list';
            customItemsArray.forEach(item => {
                const itemId = `grocery-Custom-${item.replace(/[\s()']/g, '-')}`; // Sanitize ID
                list.appendChild(createGroceryItem(item, itemId, checkedItemsMap[itemId] || false));
            });
            categoryDiv.appendChild(list);
            listContainer.appendChild(categoryDiv);
        }
        
        if (!itemsRendered && customItemsArray.length === 0) { // If no predefined items and no custom items
             listContainer.innerHTML = "<p style='text-align:center; color: var(--text-muted);'>Your grocery list is currently empty. Use the field above to add items.</p>";
        }
    }
    
    function createGroceryItem(itemName, itemId, isCheckedInitially) {
        const li = document.createElement('li');
        li.className = 'grocery-item';
        if (isCheckedInitially) {
            li.classList.add('checked');
        }
        
        li.innerHTML = `
            <label class="custom-checkbox">
                <input type="checkbox" id="${itemId}" ${isCheckedInitially ? 'checked' : ''}>
                <span class="checkmark"></span>
            </label>
            <span class="item-name">${itemName}</span>
        `;
        
        const checkbox = li.querySelector('input[type="checkbox"]');
        checkbox.addEventListener('change', function() {
            const isChecked = this.checked;
            li.classList.toggle('checked', isChecked);
            saveCheckedStateToFirestore(this.id, isChecked);
        });
        return li;
    }

    async function addCustomItem() {
        const itemName = newItemInput.value.trim();
        if (itemName === '' || !currentUserId) return;

        let customItems = [];
        try {
            const customItemsDocRef = db.collection('users').doc(currentUserId).collection('groceryData').doc('customItems');
            const docSnap = await customItemsDocRef.get();
            if (docSnap.exists() && docSnap.data().items) {
                customItems = docSnap.data().items;
            }
        } catch (e) {
            console.error("Error fetching current custom items:", e);
        }

        if (!customItems.includes(itemName)) {
            customItems.push(itemName);
            await saveCustomGroceryItemsToFirestore(customItems);
            // For re-render, fetch current checked states to pass them along
            let checkedItemsData = {};
            try {
                 const checkedItemsDocRef = db.collection('users').doc(currentUserId).collection('groceryData').doc('checkedStates');
                 const checkedSnap = await checkedItemsDocRef.get();
                 if (checkedSnap.exists()) checkedItemsData = checkedSnap.data();
            } catch (e) { console.error("Error fetching checked states for re-render:", e); }
            renderList(customItems, checkedItemsData);
        }
        newItemInput.value = '';
    }
    
    if(addItemBtn) addItemBtn.addEventListener('click', addCustomItem);
    if(newItemInput) newItemInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') { e.preventDefault(); addCustomItem(); } });
    
    if(clearCheckedBtn) {
        clearCheckedBtn.addEventListener('click', async () => {
            if (!currentUserId || !confirm('Are you sure you want to clear all checked items from your online list? This cannot be undone.')) return;
            
            try {
                await db.collection('users').doc(currentUserId).collection('groceryData').doc('checkedStates').set({}); // Set to empty object
                console.log("Checked states cleared from Firestore.");
                // Re-render the list, which will now show all items unchecked
                let customItems = []; // Need to fetch custom items again to pass to renderList
                const customItemsDocRef = db.collection('users').doc(currentUserId).collection('groceryData').doc('customItems');
                const docSnap = await customItemsDocRef.get();
                if (docSnap.exists() && docSnap.data().items) customItems = docSnap.data().items;
                renderList(customItems, {}); // Pass empty checkedItemsMap
            } catch (error) {
                console.error("Error clearing checked items from Firestore:", error);
            }
        });
    }
    
    // --- Deals Feature (Simulated) ---
    if (findDealsBtn) {
        findDealsBtn.addEventListener('click', () => {
            if (!navigator.geolocation) {
                alert("Geolocation is not supported by your browser.");
                return;
            }
            findDealsBtn.textContent = "Finding deals...";
            findDealsBtn.disabled = true;
            navigator.geolocation.getCurrentPosition(successGeo, errorGeo);
        });
    }

    function successGeo(position) {
        if (!dealsContainer) return;
        dealsContainer.innerHTML = ''; 
        const simulatedDeals = [
            { store: 'Fortinos', item: 'Chicken Breast', price: '$1.99/lb' },
            { store: 'Food Basics', item: 'Avocados', price: '5 for $4.00' },
            { store: 'Sobeys', item: 'Greek Yogurt', price: '$4.99' },
            { store: 'Walmart', item: 'Salmon Fillets', price: '$9.97/lb' },
            { store: 'NoFrills', item: 'Mixed Berries (Frozen)', price: '2 for $7.00' },
            { store: 'Costco (Membership)', item: 'Almond Milk (Case)', price: '$9.89' },
        ];
        simulatedDeals.forEach(deal => {
            const dealCard = document.createElement('div');
            dealCard.className = 'deal-card';
            dealCard.innerHTML = `<h3>${deal.item}</h3><p><strong>Store:</strong> ${deal.store}</p><p><strong>Price:</strong> ${deal.price}</p>`;
            dealsContainer.appendChild(dealCard);
        });
        if(findDealsBtn) {
            findDealsBtn.textContent = "Find Deals Near Me";
            findDealsBtn.disabled = false;
        }
    }

    function errorGeo() {
        alert("Unable to retrieve your location. Please ensure location services are enabled for your browser.");
        if(findDealsBtn) {
            findDealsBtn.textContent = "Find Deals Near Me";
            findDealsBtn.disabled = false;
        }
    }
});
</script>