<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Grocery List</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="firebase-init.js"></script>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Your existing CSS is unchanged */
        body { background-color: var(--color-background-dark); color: var(--color-text-light); }
        .container { max-width: 960px; margin: 30px auto; padding: 20px; }
        .header { text-align: center; margin-bottom: 40px; }
        .header h1 { font-size: 2.8rem; color: var(--color-text-highlight); text-shadow: 0 0 10px var(--color-secondary); margin-bottom: 20px; }
        .back-link { display: inline-block; background-color: var(--color-primary); color: #fff; text-decoration: none; font-weight: 600; padding: 10px 20px; border-radius: var(--border-radius-base); transition: background-color 0.3s, transform 0.2s; box-shadow: var(--shadow-elevation-1); }
        .back-link:hover { background-color: #0056b3; transform: translateY(-2px); box-shadow: var(--shadow-elevation-2); }
        .deals-section { background-color: var(--color-card-background); padding: 30px; border-radius: var(--border-radius-base); margin-bottom: 40px; border: 1px solid var(--color-border-subtle); box-shadow: var(--shadow-elevation-1); }
        .deals-section h2 { font-size: 2rem; color: var(--color-tertiary); border-bottom: 2px solid var(--color-border-subtle); padding-bottom: 15px; margin-top: 0; margin-bottom: 25px; text-align: center; }
        #findDealsBtn, #generateMealIdeasBtn { display: block; width: 100%; padding: 15px; font-size: 1.2rem; font-weight: 600; background: linear-gradient(45deg, var(--color-tertiary), #8e44ad); color: #fff; border: none; border-radius: var(--border-radius-base); cursor: pointer; transition: background 0.3s, transform 0.2s, box-shadow 0.3s; margin-bottom: 20px; box-shadow: var(--shadow-elevation-1); }
        #findDealsBtn:hover, #generateMealIdeasBtn:hover { background: linear-gradient(45deg, #8e44ad, var(--color-tertiary)); transform: translateY(-2px); box-shadow: var(--shadow-elevation-2); }
        #deals-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .deal-card { background-color: var(--color-input-background); border: 1px solid var(--color-border-subtle); padding: 20px; border-radius: var(--border-radius-base); box-shadow: var(--shadow-elevation-1); transition: transform 0.2s ease; }
        .deal-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-elevation-2); }
        .deal-card h3 { color: var(--color-secondary); margin-top: 0; margin-bottom: 10px; font-size: 1.3rem; }
        .deal-card p { margin: 5px 0 0 0; color: var(--color-text-muted); font-size: 0.95rem; }
        .add-item-form { display: flex; gap: 15px; margin-bottom: 30px; background-color: var(--color-card-background); padding: 20px; border-radius: var(--border-radius-base); border: 1px solid var(--color-border-subtle); box-shadow: var(--shadow-elevation-1); flex-wrap: wrap; }
        .add-item-form input[type="text"] { flex-grow: 1; background-color: var(--color-input-background); border: 1px solid var(--color-border-subtle); color: var(--color-text-light); padding: 12px 18px; border-radius: var(--border-radius-base); font-size: 1rem; outline: none; transition: border-color 0.3s, box-shadow 0.3s; min-width: 200px; }
        .add-item-form input[type="text"]:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.2); }
        .add-item-form button { background-color: var(--color-primary); color: #fff; border: none; padding: 12px 25px; border-radius: var(--border-radius-base); font-weight: 600; cursor: pointer; transition: background-color 0.3s, transform 0.2s, box-shadow 0.3s; box-shadow: var(--shadow-elevation-1); }
        .add-item-form button:hover { background-color: #0056b3; transform: translateY(-2px); box-shadow: var(--shadow-elevation-2); }
        .grocery-category { background-color: var(--color-card-background); padding: 25px; border-radius: var(--border-radius-base); margin-bottom: 25px; border: 1px solid var(--color-border-subtle); box-shadow: var(--shadow-elevation-1); }
        .grocery-category h2 { font-size: 1.8rem; color: var(--color-primary); border-bottom: 2px solid var(--color-border-subtle); padding-bottom: 10px; margin-top: 0; margin-bottom: 20px; text-align: left; }
        .grocery-list { list-style: none; padding: 0; }
        .grocery-item { background-color: var(--color-input-background); padding: 15px 20px; border-radius: var(--border-radius-base); margin-bottom: 10px; display: flex; align-items: center; transition: opacity 0.3s, background-color 0.3s; border: 1px solid var(--color-border-subtle); }
        .grocery-item.checked { opacity: 0.6; background-color: rgba(46, 204, 113, 0.1); border-color: var(--color-secondary); }
        .grocery-item.checked .item-name { text-decoration: line-through; color: var(--color-text-muted); }
        .item-name { flex-grow: 1; font-size: 1.1rem; color: var(--color-text-light); }
        .custom-checkbox { display: inline-flex; align-items: center; cursor: pointer; margin-right: 15px; }
        .custom-checkbox input { display: none; }
        .checkmark { min-width: 24px; height: 24px; background-color: var(--color-background-dark); border: 2px solid var(--color-border-subtle); border-radius: 6px; position: relative; transition: all 0.2s ease; }
        .custom-checkbox:hover .checkmark { border-color: var(--color-secondary); }
        .custom-checkbox input:checked + .checkmark { background-color: var(--color-secondary); border-color: var(--color-secondary); }
        .checkmark::after { content: ''; position: absolute; display: none; left: 8px; top: 4px; width: 5px; height: 12px; border: solid white; border-width: 0 3px 3px 0; transform: rotate(45deg); }
        .custom-checkbox input:checked + .checkmark::after { display: block; }
        .controls { text-align: center; margin-top: 40px; }
        .clear-btn { background-color: var(--color-danger); color: #fff; border: none; padding: 12px 25px; border-radius: var(--border-radius-base); font-weight: 600; cursor: pointer; transition: background-color 0.3s, transform 0.2s, box-shadow 0.3s; box-shadow: var(--shadow-elevation-1); }
        .clear-btn:hover { background-color: #c0392b; transform: translateY(-2px); box-shadow: var(--shadow-elevation-2); }
        @media (max-width: 768px) { .header h1 { font-size: 2.2rem; } .deals-section h2, .grocery-category h2 { font-size: 1.6rem; } #deals-container { grid-template-columns: 1fr; } .add-item-form { flex-direction: column; gap: 10px; } .add-item-form input[type="text"], .add-item-form button { width: 100%; } }
        @media (max-width: 480px) { .header h1 { font-size: 1.8rem; } .deals-section h2, .grocery-category h2 { font-size: 1.4rem; } .grocery-item { padding: 12px 15px; } .item-name { font-size: 1rem; } .checkmark { width: 20px; height: 20px; } .checkmark::after { left: 7px; top: 3px; width: 4px; height: 10px; } }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <h1>My Grocery List</h1>
            <a href="./index.html" class="back-link">← Back to Tracker</a>
        </div>
        <div class="deals-section">
            <h2>Nearby Deals</h2>
            <button id="findDealsBtn">Find Deals Near Me</button>
            <button id="generateMealIdeasBtn">✨ Generate Meal Ideas</button>
            <div id="deals-container"></div>
        </div>
        <div class="add-item-form">
            <input type="text" id="newItemInput" placeholder="Add a custom item...">
            <button id="addItemBtn">Add Item</button>
        </div>
        <div id="full-grocery-list"></div>
        <div class="controls">
            <button class="clear-btn" id="clearCheckedBtn">Clear Checked Items</button>
        </div>
    </div>

    <footer class="app-footer">
        <p>© 2024 Fitness Forge. All rights reserved.</p>
    </footer>

    <script>
    let currentUser = null;

    // *** FIX #1: COPIED THE WORKOUT DATA HERE SO THE PAGE CAN ACCESS IT ***
    const workoutPrograms = [
        { id: '3-week-bootcamp', name: '3-Week Bootcamp (Weight Loss & Toning)', days: [ /* ...all days... */ ] },
        { id: '6-week-strength', name: '6-Week Strength Builder (Muscle Gain & Power)', days: [ /* ...all days... */ ] },
        { id: '4-week-weight-loss', name: '4-Week Fat Shredder (Weight Loss & Cardio)', days: [ /* ...all days... */ ] },
        { id: '8-week-muscle-gain', name: '8-Week Muscle Gain (Hypertrophy & Strength)', days: [ /* ...all days... */ ] },
        { id: '12-week-transformation', name: '12-Week Total Transformation (Comprehensive Fitness)', days: [ /* ...all days... */ ] }
    ];
    // Note: To keep this code block shorter, I've omitted the full day details.
    // Please ensure you copy the full, detailed workoutPrograms array from your index.html here.

    function initializeGroceryUI(user) {
        currentUser = user; 

        const listContainer = document.getElementById('full-grocery-list');
        const newItemInput = document.getElementById('newItemInput');
        const addItemBtn = document.getElementById('addItemBtn');
        const clearCheckedBtn = document.getElementById('clearCheckedBtn');
        const findDealsBtn = document.getElementById('findDealsBtn');
        const dealsContainer = document.getElementById('deals-container');
        const generateMealIdeasBtn = document.getElementById('generateMealIdeasBtn');

        const userDocRef = db.collection('users').doc(currentUser.uid);

        async function loadAndRenderGroceryList() {
            try {
                const userProfile = await userDocRef.get();
                if (userProfile.exists && userProfile.data().selectedProgramId) {
                    const selectedProgramId = userProfile.data().selectedProgramId;
                    const selectedProgram = workoutPrograms.find(p => p.id === selectedProgramId);

                    if (selectedProgram) {
                        const categorizedItems = generateGroceryListFromProgram(selectedProgram);
                        await renderList(categorizedItems); // Pass categorized items to renderList
                    } else {
                        await renderList({}); // Render an empty list if program not found
                    }
                } else {
                    await renderList({}); // Render an empty list if no profile/program
                }
            } catch (e) {
                console.error("Error loading grocery list:", e);
                await renderList({});
            }
        }

        function generateGroceryListFromProgram(program) {
            const categorizedItems = {};
            program.days.forEach(day => {
                if (!day.meals) return;
                for (const mealType in day.meals) {
                    // This complex parsing logic is kept as you wrote it
                }
            });
            return categorizedItems;
        }

        // --- Deals Feature ---
        findDealsBtn.addEventListener('click', () => {
            if (!navigator.geolocation) {
                showCustomModal("Geolocation is not supported by your browser.");
                return;
            }
            // NOTE: For Geolocation to work, your site must be served over HTTPS.
            // It will be blocked on http://localhost or file:// paths.
            findDealsBtn.textContent = "Finding deals...";
            findDealsBtn.disabled = true;
            navigator.geolocation.getCurrentPosition(success, error);
        });

        function success(position) { /* Your existing function */ }
        function error() { /* Your existing function */ }
        function showCustomModal(message, onConfirm = null) { /* Your existing function */ }
        
        // *** FIX #2: REWRITTEN renderList and createGroceryItem to work correctly ***
        async function renderList(categorizedItems) {
            listContainer.innerHTML = '';
            const allItemPromises = [];

            // Create promises for program items
            for (const category in categorizedItems) {
                categorizedItems[category].forEach(item => {
                    allItemPromises.push(createGroceryItem(item, category));
                });
            }

            // Create promises for custom items
            const customItemsDoc = await userDocRef.collection('grocery_custom_items').doc('items').get();
            const customItems = customItemsDoc.exists ? (customItemsDoc.data().items || []) : [];
            customItems.forEach(item => {
                allItemPromises.push(createGroceryItem(item, "My Added Items"));
            });

            // Wait for all <li> elements to be created
            const resolvedListItems = await Promise.all(allItemPromises);
            
            // Group the created <li> elements by category
            const finalCategories = {};
            resolvedListItems.forEach(li => {
                if (!li) return; // Skip if item creation failed
                const category = li.dataset.category;
                if (!finalCategories[category]) {
                    finalCategories[category] = [];
                }
                finalCategories[category].push(li);
            });

            // Render the categories and items to the page
            for (const categoryName in finalCategories) {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'grocery-category';
                categoryDiv.innerHTML = `<h2>${categoryName}</h2>`;
                const list = document.createElement('ul');
                list.className = 'grocery-list';
                finalCategories[categoryName].forEach(li => list.appendChild(li));
                categoryDiv.appendChild(list);
                listContainer.appendChild(categoryDiv);
            }

            // Re-attach event listeners
            document.querySelectorAll('.grocery-item input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', handleCheckboxChange);
            });
        }
        
        async function createGroceryItem(itemName, category) {
            const itemId = `grocery-${category.replace(/\s+/g, '-')}-${itemName.replace(/\s+/g, '-')}`;
            const li = document.createElement('li');
            li.className = 'grocery-item';
            li.id = `li-${itemId}`;
            li.dataset.category = category; // Store category for re-grouping

            const itemDoc = await userDocRef.collection('grocery_item_states').doc(itemId).get();
            const isChecked = itemDoc.exists ? itemDoc.data().checked : false;
            
            if (isChecked) li.classList.add('checked');
            li.innerHTML = `<label class="custom-checkbox"><input type="checkbox" id="${itemId}" ${isChecked ? 'checked' : ''}><span class="checkmark"></span></label><span class="item-name">${itemName}</span>`;
            return li;
        }

        function handleCheckboxChange(e) { /* Your existing function */ }

        async function addCustomItem() {
            const itemName = newItemInput.value.trim();
            if (itemName === '') return;
            try {
                const docRef = userDocRef.collection('grocery_custom_items').doc('items');
                const doc = await docRef.get();
                let customItems = doc.exists ? (doc.data().items || []) : [];
                
                if (!customItems.includes(itemName)) {
                    customItems.push(itemName);
                    await docRef.set({ items: customItems });
                    newItemInput.value = '';
                    loadAndRenderGroceryList(); // Reload the whole list to show the new item
                }
            } catch (e) {
                console.error("Error adding custom grocery item:", e);
                showCustomModal("Failed to add item. Please try again.");
            }
        }

        function clearCheckedItems() { /* Your existing function */ }

        addItemBtn.addEventListener('click', addCustomItem);
        newItemInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') addCustomItem(); });
        clearCheckedBtn.addEventListener('click', clearCheckedItems);
        generateMealIdeasBtn.addEventListener('click', async () => { /* Your existing function */ });

        loadAndRenderGroceryList();
    }

    // *** FIX #3: REPLACED old timer script with the robust Firebase Auth Listener ***
    document.addEventListener('DOMContentLoaded', () => {
        firebase.auth().onAuthStateChanged(user => {
            const path = window.location.pathname;
            const isGroceryPage = path.endsWith('/grocery_list.html');
            const isAuthPage = path.endsWith('/auth.html');

            if (user) {
                if (isAuthPage) {
                    window.location.href = './index.html';
                    return;
                }
                if (isGroceryPage) {
                    initializeGroceryUI(user);
                }
            } else {
                if (!isAuthPage) {
                    window.location.href = './auth.html';
                }
            }
        });
    });
    </script>
</body>
</html>